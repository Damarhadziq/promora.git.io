<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pembayaran Paket Premium - Promora</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    
    body {
      font-family: 'Inter', sans-serif;
    }
    
    .payment-method {
      transition: all 0.3s ease;
    }
    
    .payment-method:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(122, 90, 248, 0.15);
    }
    
    .payment-method.selected {
      border-color: #7A5AF8;
      background-color: #F5F3FF;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
  </style>
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: '#7A5AF8' } } } }
  </script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Main Content -->
  <main class="min-h-screen flex items-center justify-center px-6 py-10">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-2xl">

      <!-- Top Bar: Timer + Total -->
      <div class="bg-primary text-white p-6 text-center">
        <div class="flex items-center justify-center gap-3 text-lg mb-3">
          <i class="fas fa-clock animate-pulse"></i>
          <span>Batas akhir pembayaran:</span>
          <span id="countdown" class="font-bold text-xl">23:59:59</span>
        </div>
        <div class="text-4xl font-bold mt-2" id="total-bayar">Rp 0</div>
        <p class="text-sm opacity-90 mt-1">Total Pembayaran</p>
      </div>

      <div class="p-8 space-y-8">

        <!-- Detail Paket -->
        <div class="border-t pt-6 mb-6">
          <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
            <i class="fas fa-box-open text-purple-600"></i>
            Detail Paket Langganan
          </h3>
          <div class="bg-purple-50 rounded-xl p-5 border border-purple-200">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <img id="package-badge" src="assets/img/gold.png" alt="Badge" class="w-12 h-12">
                <div>
                  <h4 id="package-name" class="font-bold text-lg text-gray-900">Paket Gold</h4>
                  <p class="text-sm text-gray-600">Langganan Premium Seller</p>
                </div>
              </div>
              <div class="text-right">
                <p id="package-price" class="text-2xl font-bold text-purple-600">Rp 199.000</p>
                <p class="text-xs text-gray-500">per bulan</p>
              </div>
            </div>
            
            <div class="mt-4 pt-4 border-t border-purple-200 space-y-2 text-sm">
              <div class="flex items-center gap-2 text-gray-700">
                <i class="fas fa-check-circle text-green-500"></i>
                <span id="benefit-1">Biaya Admin Dalam Negeri: 2%</span>
              </div>
              <div class="flex items-center gap-2 text-gray-700">
                <i class="fas fa-check-circle text-green-500"></i>
                <span id="benefit-2">Biaya Admin Luar Negeri: 5%</span>
              </div>
              <div class="flex items-center gap-2 text-gray-700">
                <i class="fas fa-check-circle text-green-500"></i>
                <span id="benefit-3">Banner Dinamis: 10x per minggu</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Pilih Metode Pembayaran -->
<div class="space-y-5" id="payment-methods-container">
  <h3 class="font-bold text-lg flex items-center gap-2">
    <i class="fas fa-credit-card text-purple-600"></i>
    Pilih Metode Pembayaran
  </h3>

  <!-- Bank BRI -->
  <div onclick="selectPayment('bri', 'Bank BRI')" class="payment-method border-2 rounded-xl p-4 cursor-pointer">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/2e/BRI_2020.svg/240px-BRI_2020.svg.png" alt="BRI" class="w-10 h-10 object-contain">
        </div>
        <div>
          <p class="font-bold text-gray-800">Bank BRI</p>
          <p class="text-sm text-gray-500">Transfer ke rekening BRI</p>
        </div>
      </div>
      <input type="radio" name="payment" class="w-5 h-5 text-purple-600">
    </div>
    <div id="detail-bri" class="mt-4 hidden bg-white border border-purple-200 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 uppercase mb-2">Nomor Rekening BRI</p>
          <p class="text-2xl font-mono font-bold tracking-wider text-primary">0024 0123 4567 890</p>
          <p class="text-sm text-gray-600 mt-1">a.n. PROMORA JASTIP INDONESIA</p>
        </div>
        <button onclick="copy('002401234567890'); event.stopPropagation();" class="px-4 py-2 bg-primary text-white rounded-full text-sm font-medium hover:bg-purple-700 transition">
          <i class="fas fa-copy mr-1"></i>Salin
        </button>
      </div>
    </div>
  </div>

  <!-- Bank BNI -->
  <div onclick="selectPayment('bni', 'Bank BNI')" class="payment-method border-2 rounded-xl p-4 cursor-pointer">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center">
          <img src="./assets/img/bni.png" alt="BNI" class="w-10 h-10 object-contain">
        </div>
        <div>
          <p class="font-bold text-gray-800">Bank BNI</p>
          <p class="text-sm text-gray-500">Transfer ke rekening BNI</p>
        </div>
      </div>
      <input type="radio" name="payment" class="w-5 h-5 text-purple-600">
    </div>
    <div id="detail-bni" class="mt-4 hidden bg-white border border-purple-200 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 uppercase mb-2">Nomor Rekening BNI</p>
          <p class="text-2xl font-mono font-bold tracking-wider text-primary">0461 2345 6789 012</p>
          <p class="text-sm text-gray-600 mt-1">a.n. PROMORA JASTIP INDONESIA</p>
        </div>
        <button onclick="copy('046123456789012'); event.stopPropagation();" class="px-4 py-2 bg-primary text-white rounded-full text-sm font-medium hover:bg-purple-700 transition">
          <i class="fas fa-copy mr-1"></i>Salin
        </button>
      </div>
    </div>
  </div>

  <!-- QRIS -->
  <div onclick="selectPayment('qris', 'QRIS')" class="payment-method border-2 rounded-xl p-4 cursor-pointer">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e1/QRIS_logo.svg/240px-QRIS_logo.svg.png" alt="QRIS" class="w-10 h-10 object-contain">
        </div>
        <div>
          <p class="font-bold text-gray-800">QRIS</p>
          <p class="text-sm text-gray-500">Scan QR untuk bayar</p>
        </div>
      </div>
      <input type="radio" name="payment" class="w-5 h-5 text-purple-600">
    </div>
    <div id="detail-qris" class="mt-4 hidden text-center bg-white border border-purple-200 rounded-xl p-4">
      <p class="text-sm text-gray-600 mb-3">Scan QR Code dengan aplikasi:</p>
      <div class="flex justify-center gap-2 mb-3 flex-wrap">
        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">GoPay</span>
        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">OVO</span>
        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">DANA</span>
        <span class="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium">ShopeePay</span>
      </div>
      <img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=00020101021226670016ID.CO.QRIS.WWW0118ID1234567890123456520454995303360540510000.005802ID5925PROMORA%20JASTIP%20INDO6007JAKARTA61051234062070703A0163044BCA" 
           alt="QRIS" class="mx-auto w-48 h-48 rounded-xl shadow-lg border-2 border-purple-200 bg-white p-2">
      <p class="mt-3 text-xs text-gray-500">
        <i class="fas fa-info-circle mr-1"></i>
        Nominal akan terdeteksi otomatis saat scan QR
      </p>
    </div>
  </div>

  <!-- E-Wallet OVO -->
  <div onclick="selectPayment('ovo', 'OVO')" class="payment-method border-2 rounded-xl p-4 cursor-pointer">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Logo_ovo_purple.svg/240px-Logo_ovo_purple.svg.png" alt="OVO" class="w-10 h-10 object-contain">
        </div>
        <div>
          <p class="font-bold text-gray-800">OVO</p>
          <p class="text-sm text-gray-500">Transfer ke nomor OVO</p>
        </div>
      </div>
      <input type="radio" name="payment" class="w-5 h-5 text-purple-600">
    </div>
    <div id="detail-ovo" class="mt-4 hidden bg-white border border-purple-200 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 uppercase mb-2">Nomor OVO</p>
          <p class="text-2xl font-mono font-bold tracking-wider text-primary">0812-3456-7890</p>
          <p class="text-sm text-gray-600 mt-1">a.n. PROMORA JASTIP</p>
        </div>
        <button onclick="copy('081234567890'); event.stopPropagation();" class="px-4 py-2 bg-primary text-white rounded-full text-sm font-medium hover:bg-purple-700 transition">
          <i class="fas fa-copy mr-1"></i>Salin
        </button>
      </div>
    </div>
  </div>

  <!-- E-Wallet GoPay -->
  <div onclick="selectPayment('gopay', 'GoPay')" class="payment-method border-2 rounded-xl p-4 cursor-pointer">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/86/Gopay_logo.svg/240px-Gopay_logo.svg.png" alt="GoPay" class="w-10 h-10 object-contain">
        </div>
        <div>
          <p class="font-bold text-gray-800">GoPay</p>
          <p class="text-sm text-gray-500">Transfer ke nomor GoPay</p>
        </div>
      </div>
      <input type="radio" name="payment" class="w-5 h-5 text-purple-600">
    </div>
    <div id="detail-gopay" class="mt-4 hidden bg-white border border-purple-200 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 uppercase mb-2">Nomor GoPay</p>
          <p class="text-2xl font-mono font-bold tracking-wider text-primary">0812-3456-7890</p>
          <p class="text-sm text-gray-600 mt-1">a.n. PROMORA JASTIP</p>
        </div>
        <button onclick="copy('081234567890'); event.stopPropagation();" class="px-4 py-2 bg-primary text-white rounded-full text-sm font-medium hover:bg-purple-700 transition">
          <i class="fas fa-copy mr-1"></i>Salin
        </button>
      </div>
    </div>
  </div>

  <!-- E-Wallet DANA -->
  <div onclick="selectPayment('dana', 'DANA')" class="payment-method border-2 rounded-xl p-4 cursor-pointer">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
          <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/72/Logo_dana_blue.svg/240px-Logo_dana_blue.svg.png" alt="DANA" class="w-10 h-10 object-contain">
        </div>
        <div>
          <p class="font-bold text-gray-800">DANA</p>
          <p class="text-sm text-gray-500">Transfer ke nomor DANA</p>
        </div>
      </div>
      <input type="radio" name="payment" class="w-5 h-5 text-purple-600">
    </div>
    <div id="detail-dana" class="mt-4 hidden bg-white border border-purple-200 rounded-xl p-4">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs text-gray-500 uppercase mb-2">Nomor DANA</p>
          <p class="text-2xl font-mono font-bold tracking-wider text-primary">0812-3456-7890</p>
          <p class="text-sm text-gray-600 mt-1">a.n. PROMORA JASTIP</p>
        </div>
        <button onclick="copy('081234567890'); event.stopPropagation();" class="px-4 py-2 bg-primary text-white rounded-full text-sm font-medium hover:bg-purple-700 transition">
          <i class="fas fa-copy mr-1"></i>Salin
        </button>
      </div>
    </div>
  </div>
</div>

        <!-- Ringkasan -->
        <div class="border-t pt-6 space-y-3">
          <div class="flex justify-between font-medium">
            <span>Paket Langganan</span>
            <span id="summary-package">Paket Gold</span>
          </div>
          <div class="flex justify-between text-gray-600">
            <span>Harga</span>
            <span id="summary-price">Rp 199.000</span>
          </div>
          <div class="flex justify-between text-gray-600">
            <span>Biaya Admin</span>
            <span>Rp 0</span>
          </div>

          <hr class="my-3 border-dashed">

          <div class="flex justify-between text-lg font-bold text-primary">
            <span>Total Bayar</span>
            <span id="summary-total">Rp 199.000</span>
          </div>
        </div>

        <!-- Tombol Aksi -->
        <div class="flex gap-4 pt-4">
          <a href="pricingCard.html" class="flex-1 text-center py-4 bg-gray-200 text-gray-700 rounded-full font-bold hover:bg-gray-300 transition text-lg">
            Batalkan
          </a>
          <button onclick="openModal()" id="btn-bayar" class="flex-1 py-4 bg-primary text-white rounded-full font-bold hover:bg-purple-700 transition text-lg shadow-lg opacity-50 cursor-not-allowed" disabled>
            Lanjut Bayar
          </button>
        </div>

        <p class="text-center text-xs text-gray-500 mt-4">
          Setelah pembayaran terdeteksi, upload bukti dan tunggu verifikasi dari admin.
        </p>
      </div>
    </div>
  </main>

  <!-- MODAL UPLOAD BUKTI -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 hidden flex items-center justify-center z-50 p-4 overflow-y-auto">
    <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md my-8">
      <div class="p-8">
        <div class="text-center mb-6">
          <i class="fas fa-receipt text-6xl text-primary mb-4"></i>
          <h3 class="text-2xl font-bold">Upload Bukti Transfer</h3>
          <p class="text-gray-600 mt-2">Kirim bukti agar langganan segera aktif</p>
        </div>

        <div id="payment-info" class="mb-6 p-4 bg-purple-50 rounded-xl border border-purple-200">
          <p class="text-sm text-gray-700 mb-2"><strong>Metode:</strong> <span id="selected-method">-</span></p>
          <p class="text-sm text-gray-700"><strong>Total:</strong> <span id="selected-total">Rp 0</span></p>
        </div>

        <div id="drop-area" class="border-4 border-dashed border-primary rounded-2xl p-10 text-center cursor-pointer hover:bg-purple-50 transition">
          <input type="file" id="file-input" accept="image/*" class="hidden">
          <i class="fas fa-cloud-upload-alt text-5xl text-primary mb-4"></i>
          <p class="font-medium text-lg">Klik atau drag gambar ke sini</p>
          <p class="text-sm text-gray-500 mt-2">Maksimal 5MB ‚Ä¢ JPG/PNG</p>
        </div>

        <div id="preview" class="mt-6 hidden text-center">
          <img id="preview-img" class="w-full max-w-xs mx-auto rounded-xl shadow-lg" alt="Preview">
          <p class="mt-4 text-green-600 font-medium">Bukti siap dikirim!</p>
        </div>

        <div class="flex gap-4 mt-8">
          <button onclick="closeModal()" class="flex-1 py-4 bg-gray-200 text-gray-700 rounded-full font-bold hover:bg-gray-300 transition">
            Batal
          </button>
          <button onclick="kirimBukti()" id="btn-kirim" class="flex-1 py-4 bg-primary text-white rounded-full font-bold hover:bg-purple-700 transition opacity-50 cursor-not-allowed" disabled>
            Kirim Bukti
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifikasi Berhasil -->
  <div id="notif" class="fixed inset-0 bg-black bg-opacity-80 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl p-12 text-center max-w-md">
      <i class="fas fa-check-circle text-6xl text-green-500 mb-6"></i>
      <h3 class="text-2xl font-bold text-gray-800 mb-4">Pembayaran Berhasil!</h3>
      <p class="text-gray-600 leading-relaxed">
        Bukti pembayaran sudah tersimpan. Paket Premium Seller Anda akan segera aktif setelah verifikasi admin.
      </p>
      <div class="mt-6 p-4 bg-purple-50 rounded-lg border border-purple-200">
        <p class="text-sm text-purple-700">
          <i class="fas fa-info-circle mr-2"></i>
          Anda akan diarahkan ke halaman seller dalam beberapa detik...
        </p>
      </div>
    </div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Cek session menggunakan endpoint yang sama dengan homeSeller
        const response = await fetch('backend/api/get_store_profile.php', {
            credentials: 'include'
        });
        const data = await response.json();
        
        if (!data.success || !data.store) {
            alert('Silakan login terlebih dahulu!');
            window.location.href = 'lamanLogin.html';
            return;
        }
        
        console.log('Store logged in:', data.store.store_name, 'ID:', data.store.seller_id);
        
        // Load package data setelah verify session
        loadPackageData();
        startCountdown();
    } catch (error) {
        console.error('Session check error:', error);
        alert('Gagal memeriksa status login. Silakan login kembali.');
        window.location.href = 'lamanLogin.html';
    }
});

// ============================================
// 2. GET URL PARAMETERS (FIX)
// ============================================
const urlParams = new URLSearchParams(window.location.search);
const paketName = urlParams.get('paket') || 'Gold';
const paketPrice = parseInt(urlParams.get('harga')) || 199000;
const duration = parseInt(urlParams.get('durasi')) || 1;
const totalPrice = parseInt(urlParams.get('total')) || paketPrice;

console.log('URL Parameters:', { paketName, paketPrice, duration, totalPrice });

// ============================================
// 3. PACKAGE BENEFITS CONFIG
// ============================================
const packageBenefits = {
    'Gold': {
        badge: 'assets/img/gold.png',
        benefit1: 'Biaya Admin Dalam Negeri: 2%',
        benefit2: 'Biaya Admin Luar Negeri: 5%',
        benefit3: 'Banner Dinamis: 10x per minggu'
    },
    'Silver': {
        badge: 'assets/img/silver.png',
        benefit1: 'Biaya Admin Dalam Negeri: 3.5%',
        benefit2: 'Biaya Admin Luar Negeri: 7%',
        benefit3: 'Banner Dinamis: 2x per minggu'
    },
    'Bronze': {
        badge: 'assets/img/bronze.png',
        benefit1: 'Biaya Admin Dalam Negeri: 4%',
        benefit2: 'Biaya Admin Luar Negeri: 8%',
        benefit3: 'Banner Dinamis: Tidak tersedia'
    }
};

// ============================================
// 4. LOAD PACKAGE DATA (FIX TOTAL DISPLAY)
// ============================================
function loadPackageData() {
    const benefits = packageBenefits[paketName];
    
    if (!benefits) {
        console.error('Package not found:', paketName);
        alert('Paket tidak ditemukan!');
        window.location.href = 'pricingCard.html';
        return;
    }
    
    // Update package details
    document.getElementById('package-badge').src = benefits.badge;
    document.getElementById('package-name').textContent = `Paket ${paketName}`;
    document.getElementById('package-price').textContent = `Rp ${paketPrice.toLocaleString('id-ID')}`;
    document.getElementById('benefit-1').textContent = benefits.benefit1;
    document.getElementById('benefit-2').textContent = benefits.benefit2;
    document.getElementById('benefit-3').textContent = benefits.benefit3;
    
    // Update summary section
    const summaryText = duration === 1 
        ? `Paket ${paketName}` 
        : `Paket ${paketName} (${duration} bulan)`;
    
    document.getElementById('summary-package').textContent = summaryText;
    document.getElementById('summary-price').textContent = `Rp ${totalPrice.toLocaleString('id-ID')}`;
    document.getElementById('summary-total').textContent = `Rp ${totalPrice.toLocaleString('id-ID')}`;
    
    // **FIX: Update total bayar di header**
    document.getElementById('total-bayar').textContent = `Rp ${totalPrice.toLocaleString('id-ID')}`;
    
    // Tambahkan info detail harga jika lebih dari 1 bulan
    const priceContainer = document.getElementById('summary-price').parentElement;
    const existingDetail = priceContainer.querySelector('.text-xs.text-gray-500');
    
    // Hapus detail lama jika ada
    if (existingDetail && existingDetail.textContent.includes('√ó')) {
        existingDetail.remove();
    }
    
    if (duration > 1) {
        const priceDetail = document.createElement('p');
        priceDetail.className = 'text-xs text-gray-500 mt-1';
        priceDetail.textContent = `${duration} bulan √ó Rp ${paketPrice.toLocaleString('id-ID')}`;
        priceContainer.appendChild(priceDetail);
    }
    
    console.log('Package data loaded successfully');
}

// ============================================
// 5. COUNTDOWN TIMER
// ============================================
function startCountdown() {
    let hours = 23, minutes = 59, seconds = 59;
    
    setInterval(() => {
        seconds--;
        if (seconds < 0) {
            seconds = 59;
            minutes--;
        }
        if (minutes < 0) {
            minutes = 59;
            hours--;
        }
        if (hours < 0) {
            hours = 0;
            minutes = 0;
            seconds = 0;
        }
        
        const countdownElement = document.getElementById('countdown');
        if (countdownElement) {
            countdownElement.textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    }, 1000);
}

// ============================================
// 6. PAYMENT METHOD SELECTION
// ============================================
let selectedPaymentMethod = null;

// Fungsi selectPayment untuk pembayaranSeller.html
function selectPayment(method, name) {
    selectedPaymentMethod = { method, name };
    
    // Remove selected dari semua
    document.querySelectorAll('.payment-method').forEach(el => {
        el.classList.remove('selected');
        el.classList.remove('border-primary', 'bg-purple-50');
        el.classList.add('border-transparent');
    });
    
    // Hide semua detail
    document.querySelectorAll('[id^="detail-"]').forEach(el => el.classList.add('hidden'));
    
    // Tandai yang dipilih
    event.currentTarget.classList.add('selected', 'border-primary', 'bg-purple-50');
    event.currentTarget.classList.remove('border-transparent');
    event.currentTarget.querySelector('input[type="radio"]').checked = true;
    
    // Show detail yang dipilih
    const detail = document.getElementById('detail-' + method);
    if (detail) detail.classList.remove('hidden');
    
    // Enable tombol bayar
    const btnBayar = document.getElementById('btn-bayar');
    btnBayar.disabled = false;
    btnBayar.classList.remove('opacity-50', 'cursor-not-allowed');
    
    console.log('Payment method selected:', method, name);
}


// ============================================
// 7. MODAL FUNCTIONS
// ============================================
function openModal() {
    if (!selectedPaymentMethod) {
        alert('Pilih metode pembayaran terlebih dahulu!');
        return;
    }
    
    document.getElementById('selected-method').textContent = selectedPaymentMethod.name;
    document.getElementById('selected-total').textContent = `Rp ${totalPrice.toLocaleString('id-ID')}`;
    document.getElementById('modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('modal').classList.add('hidden');
    document.getElementById('preview').classList.add('hidden');
    document.getElementById('file-input').value = '';
    
    const btnKirim = document.getElementById('btn-kirim');
    btnKirim.disabled = true;
    btnKirim.classList.add('opacity-50', 'cursor-not-allowed');
}

// ============================================
// 8. FILE UPLOAD HANDLING
// ============================================
const dropArea = document.getElementById('drop-area');
const fileInput = document.getElementById('file-input');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('preview-img');

dropArea.addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.size > 5242880) {
        alert('File terlalu besar! Maksimal 5MB');
        fileInput.value = '';
        return;
    }
    
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
    if (!validTypes.includes(file.type)) {
        alert('Format file tidak valid! Gunakan JPG/PNG');
        fileInput.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        previewImg.src = e.target.result;
        preview.classList.remove('hidden');
        
        const btnKirim = document.getElementById('btn-kirim');
        btnKirim.disabled = false;
        btnKirim.classList.remove('opacity-50', 'cursor-not-allowed');
    };
    reader.readAsDataURL(file);
});

dropArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropArea.classList.add('bg-purple-50');
});

dropArea.addEventListener('dragleave', () => {
    dropArea.classList.remove('bg-purple-50');
});

dropArea.addEventListener('drop', (e) => {
    e.preventDefault();
    dropArea.classList.remove('bg-purple-50');
    
    const file = e.dataTransfer.files[0];
    if (file) {
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        fileInput.files = dataTransfer.files;
        fileInput.dispatchEvent(new Event('change'));
    }
});

// Fungsi copy nomor
function copy(text) {
    navigator.clipboard.writeText(text);
    
    const notif = document.createElement('div');
    notif.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce';
    notif.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Nomor berhasil disalin!';
    document.body.appendChild(notif);
    
    setTimeout(() => notif.remove(), 2000);
}

// ============================================
// 9. SUBMIT PAYMENT PROOF (FIX ERROR 500)
// ============================================
async function kirimBukti() {
    const file = fileInput.files[0];
    if (!file) {
        alert('Pilih bukti pembayaran terlebih dahulu!');
        return;
    }

    const btnKirim = document.getElementById('btn-kirim');
    const originalText = btnKirim.textContent;
    btnKirim.disabled = true;
    btnKirim.textContent = 'Mengirim...';

    const formData = new FormData();
    formData.append('payment_proof', file);
    formData.append('package_tier', paketName.toLowerCase());
    formData.append('price', paketPrice);
    formData.append('duration_months', duration);
    formData.append('total_price', totalPrice);
    formData.append('payment_method', selectedPaymentMethod.method);

    console.log('üì§ Submitting payment:', {
        package: paketName.toLowerCase(),
        price: paketPrice,
        duration: duration,
        total: totalPrice,
        method: selectedPaymentMethod.method,
        file: {
            name: file.name,
            size: (file.size / 1024).toFixed(2) + ' KB',
            type: file.type
        }
    });

    try {
        const response = await fetch('backend/subscription/create_subscription.php', {
            method: 'POST',
            credentials: 'include',
            body: formData
        });

        console.log('üì• Response status:', response.status);
        console.log('üì• Response headers:', Object.fromEntries(response.headers));

        // Ambil response sebagai text dulu
        const responseText = await response.text();
        console.log('üì• Raw response:', responseText);

        // Cek apakah response kosong
        if (!responseText || responseText.trim() === '') {
            throw new Error('Server mengembalikan response kosong. Cek error log PHP.');
        }

        // Parse JSON
        let result;
        try {
            result = JSON.parse(responseText);
        } catch (parseError) {
            console.error('‚ùå JSON Parse Error:', parseError);
            console.error('Response yang diterima:', responseText.substring(0, 500));
            throw new Error('Server response bukan JSON valid. Mungkin ada PHP error.');
        }

        console.log('‚úÖ Parsed response:', result);
        
        if (result.success) {
            closeModal();
            document.getElementById('notif').classList.remove('hidden');
            
            setTimeout(() => {
                window.location.href = 'homeSeller.html';
            }, 3000);
        } else {
            alert('‚ùå Gagal: ' + (result.message || 'Unknown error'));
            console.error('Server error:', result);
            btnKirim.disabled = false;
            btnKirim.textContent = originalText;
        }
    } catch (error) {
        console.error('‚ùå Submit error:', error);
        alert('Terjadi kesalahan:\n' + error.message + '\n\nCek console untuk detail.');
        btnKirim.disabled = false;
        btnKirim.textContent = originalText;
    }
}

// Initialize
loadPackageData();
startCountdown();
  </script>
</body>
</html>