<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Admin Dashboard - Verifikasi Seller | Promora</title>
  <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#7A5AF8",
            },
          },
        },
      };
    </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    .status-pending { @apply bg-yellow-100 text-yellow-800 border border-yellow-200 }
    .status-verified { @apply bg-green-100 text-green-800 border border-green-200 }
    .status-rejected { @apply bg-red-100 text-red-800 border border-red-200 }
    .tab-active { @apply border-b-4 border-[#7A5AF8] text-[#7A5AF8] font-semibold }
    .tab-inactive { @apply text-gray-500 hover:text-gray-800 border-b-4 border-transparent }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    .animate-slide-in { animation: slideIn 0.4s ease-out; }

    .modal-backdrop { backdrop-filter: blur(6px); }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <div class="flex">
    <!-- Sidebar -->
    <div class="w-64 bg-gradient-to-b from-[#7A5AF8] to-[#6347d8] text-white min-h-screen p-6 shadow-2xl">
      <div class="mb-10">
        <h1 class="text-2xl font-bold flex items-center gap-2">
          <i class="ri-shield-check-line text-3xl"></i> Promora Admin
        </h1>
        <p class="text-sm text-purple-200 mt-1">Panel Verifikasi</p>
      </div>
<ul class="space-y-2">
  <li>
    <a href="#" onclick="switchMenu('seller'); return false;" id="menu-seller" class="flex items-center space-x-3 bg-white bg-opacity-20 px-4 py-3 rounded-xl">
      <i class="ri-user-search-line text-xl"></i><span>Verifikasi Seller</span>
    </a>
  </li>
  <li>
    <a href="#" onclick="switchMenu('payment'); return false;" id="menu-payment" class="flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-white hover:bg-opacity-20 transition-all">
      <i class="ri-secure-payment-line text-xl"></i><span>Verifikasi Pembayaran</span>
    </a>
  </li>
  <li>
  <a href="#" onclick="switchMenu('subscription'); return false;" id="menu-subscription" class="flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-white hover:bg-opacity-20 transition-all">
    <i class="ri-vip-crown-line text-xl"></i><span>Verifikasi Subscription</span>
  </a>
</li>
    <li>
    <a href="#" onclick="logoutAdmin(event)" class="flex items-center space-x-3 px-4 py-3 rounded-xl hover:bg-white hover:bg-opacity-20 transition-all text-red-200 hover:text-white">
      <i class="ri-logout-box-line text-xl"></i><span>Logout</span>
    </a>
  </li>
  <li class="pt-4 mt-4 border-t border-white border-opacity-20">
<div class="mt-8 bg-white bg-opacity-10 rounded-xl p-4">
  <h3 class="text-sm font-semibold mb-3 opacity-80">Ringkasan Hari Ini</h3>
  
  <!-- Seller Stats -->
  <div id="sidebar-seller-stats" class="space-y-2 text-sm">
    <div class="flex justify-between"><span class="opacity-80">Pending:</span><span class="font-bold" id="sidebar-pending">0</span></div>
    <div class="flex justify-between"><span class="opacity-80">Diverifikasi:</span><span class="font-bold" id="sidebar-verified">0</span></div>
    <div class="flex justify-between"><span class="opacity-80">Ditolak:</span><span class="font-bold" id="sidebar-rejected">0</span></div>
  </div>
  
  <!-- Payment Stats -->
<div id="sidebar-payment-stats" class="space-y-2 text-sm hidden">
  <div class="flex justify-between"><span class="opacity-80">Belum Bayar:</span><span class="font-bold" id="sidebar-payment-pending">0</span></div>
  <div class="flex justify-between"><span class="opacity-80">Menunggu:</span><span class="font-bold" id="sidebar-payment-waiting">0</span></div>
  <div class="flex justify-between"><span class="opacity-80">Terverifikasi:</span><span class="font-bold" id="sidebar-payment-verified">0</span></div>
  <div class="flex justify-between"><span class="opacity-80">Ditolak:</span><span class="font-bold" id="sidebar-payment-rejected">0</span></div>
</div>

<!-- Subscription Stats -->
<div id="sidebar-subscription-stats" class="space-y-2 text-sm hidden">
  <div class="flex justify-between"><span class="opacity-80">Pending:</span><span class="font-bold" id="sidebar-sub-pending">0</span></div>
  <div class="flex justify-between"><span class="opacity-80">Menunggu:</span><span class="font-bold" id="sidebar-sub-waiting">0</span></div>
  <div class="flex justify-between"><span class="opacity-80">Aktif:</span><span class="font-bold" id="sidebar-sub-verified">0</span></div>
  <div class="flex justify-between"><span class="opacity-80">Ditolak:</span><span class="font-bold" id="sidebar-sub-rejected">0</span></div>
</div>
</div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-8">
      <div class="flex justify-between items-center mb-8">
        <div>
          <h2 id="page-title" class="text-3xl font-bold text-gray-800">Verifikasi Seller Baru</h2>
          <p id="page-subtitle" class="text-gray-500 mt-1">Kelola dan verifikasi pendaftaran seller</p>
        </div>
        <div class="flex items-center gap-4">
          <button onclick="refreshData()" class="px-4 py-2 bg-white border rounded-xl hover:bg-gray-50 flex items-center gap-2">
            <i class="ri-refresh-line"></i> Refresh
          </button>
          <div class="flex items-center gap-2 bg-white px-4 py-2 rounded-xl shadow-sm">
            <i class="ri-calendar-line text-gray-500"></i>
            <span class="text-sm" id="current-date"></span>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div id="seller-stats" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-2xl p-6 text-white shadow-lg">
          <p class="text-yellow-100 text-sm">Menunggu</p>
          <h3 class="text-4xl font-bold mt-2" id="stat-pending">0</h3>
        </div>
        <div class="bg-gradient-to-br from-green-400 to-green-500 rounded-2xl p-6 text-white shadow-lg">
          <p class="text-green-100 text-sm">Terverifikasi</p>
          <h3 class="text-4xl font-bold mt-2" id="stat-verified">0</h3>
        </div>
        <div class="bg-gradient-to-br from-red-400 to-red-500 rounded-2xl p-6 text-white shadow-lg">
          <p class="text-red-100 text-sm">Ditolak</p>
          <h3 class="text-4xl font-bold mt-2" id="stat-rejected">0</h3>
        </div>
        <div class="bg-gradient-to-br from-blue-400 to-blue-500 rounded-2xl p-6 text-white shadow-lg">
          <p class="text-blue-100 text-sm">Total Seller</p>
          <h3 class="text-4xl font-bold mt-2" id="stat-total">0</h3>
        </div>
      </div>


<!-- Stats Cards - Payment (PERBAIKAN: hapus class hidden, gunakan style display) -->
<div id="payment-stats" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" style="display: none;">
  <div class="bg-gradient-to-br from-orange-400 to-orange-500 rounded-2xl p-6 text-white shadow-lg">
    <p class="text-orange-100 text-sm">Menunggu Pembayaran</p>
    <h3 class="text-4xl font-bold mt-2" id="stat-payment-pending">0</h3>
  </div>
  <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-2xl p-6 text-white shadow-lg">
    <p class="text-yellow-100 text-sm">Menunggu Verifikasi</p>
    <h3 class="text-4xl font-bold mt-2" id="stat-payment-waiting">0</h3>
  </div>
  <div class="bg-gradient-to-br from-green-400 to-green-500 rounded-2xl p-6 text-white shadow-lg">
    <p class="text-green-100 text-sm">Terverifikasi</p>
    <h3 class="text-4xl font-bold mt-2" id="stat-payment-verified">0</h3>
  </div>
  <div class="bg-gradient-to-br from-red-400 to-red-500 rounded-2xl p-6 text-white shadow-lg">
    <p class="text-red-100 text-sm">Ditolak</p>
    <h3 class="text-4xl font-bold mt-2" id="stat-payment-rejected">0</h3>
  </div>
</div>

<!-- Stats Cards - Subscription -->
<div id="subscription-stats" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8" style="display: none;">
  <div class="bg-gradient-to-br from-orange-400 to-orange-500 rounded-2xl p-6 text-white shadow-lg">
    <p class="text-orange-100 text-sm">Belum Bayar</p>
    <h3 class="text-4xl font-bold mt-2" id="stat-sub-pending">0</h3>
  </div>
  <div class="bg-gradient-to-br from-yellow-400 to-yellow-500 rounded-2xl p-6 text-white shadow-lg">
    <p class="text-yellow-100 text-sm">Menunggu Verifikasi</p>
    <h3 class="text-4xl font-bold mt-2" id="stat-sub-waiting">0</h3>
  </div>
  <div class="bg-gradient-to-br from-green-400 to-green-500 rounded-2xl p-6 text-white shadow-lg">
    <p class="text-green-100 text-sm">Aktif</p>
    <h3 class="text-4xl font-bold mt-2" id="stat-sub-verified">0</h3>
  </div>
  <div class="bg-gradient-to-br from-red-400 to-red-500 rounded-2xl p-6 text-white shadow-lg">
    <p class="text-red-100 text-sm">Ditolak</p>
    <h3 class="text-4xl font-bold mt-2" id="stat-sub-rejected">0</h3>
  </div>
</div>

<!-- Tabs - Seller -->
<div id="seller-tabs" class="flex space-x-8 border-b mb-8">
  <button onclick="loadSellers('pending')" id="tab-pending" class="pb-4 px-2 tab-active">Menunggu Verifikasi <span class="ml-2 bg-yellow-100 text-yellow-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-pending">0</span></button>
  <button onclick="loadSellers('verified')" id="tab-verified" class="pb-4 px-2 tab-inactive">Terverifikasi <span class="ml-2 bg-green-100 text-green-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-verified">0</span></button>
  <button onclick="loadSellers('rejected')" id="tab-rejected" class="pb-4 px-2 tab-inactive">Ditolak <span class="ml-2 bg-red-100 text-red-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-rejected">0</span></button>
</div>

<!-- Tabs - Payment (PERBAIKAN: hapus class hidden, gunakan style display) -->
<div id="payment-tabs" class="flex space-x-8 border-b mb-8" style="display: none;">
  <button onclick="loadPayments('pending')" id="tab-payment-pending" class="pb-4 px-2 tab-active">
    Menunggu Pembayaran 
    <span class="ml-2 bg-orange-100 text-orange-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-payment-pending">0</span>
  </button>
  <button onclick="loadPayments('waiting')" id="tab-payment-waiting" class="pb-4 px-2 tab-inactive">
    Menunggu Verifikasi 
    <span class="ml-2 bg-yellow-100 text-yellow-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-payment-waiting">0</span>
  </button>
  <button onclick="loadPayments('verified')" id="tab-payment-verified" class="pb-4 px-2 tab-inactive">
    Terverifikasi 
    <span class="ml-2 bg-green-100 text-green-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-payment-verified">0</span>
  </button>
  <button onclick="loadPayments('rejected')" id="tab-payment-rejected" class="pb-4 px-2 tab-inactive">
    Ditolak 
    <span class="ml-2 bg-red-100 text-red-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-payment-rejected">0</span>
  </button>
</div>

<!-- Tabs - Subscription -->
<div id="subscription-tabs" class="flex space-x-8 border-b mb-8" style="display: none;">
  <button onclick="loadSubscriptions('pending')" id="tab-sub-pending" class="pb-4 px-2 tab-inactive">
    Belum Bayar
    <span class="ml-2 bg-orange-100 text-orange-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-sub-pending">0</span>
  </button>
  <button onclick="loadSubscriptions('waiting')" id="tab-sub-waiting" class="pb-4 px-2 tab-active">
    Menunggu Verifikasi
    <span class="ml-2 bg-yellow-100 text-yellow-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-sub-waiting">0</span>
  </button>
  <button onclick="loadSubscriptions('verified')" id="tab-sub-verified" class="pb-4 px-2 tab-inactive">
    Aktif
    <span class="ml-2 bg-green-100 text-green-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-sub-verified">0</span>
  </button>
  <button onclick="loadSubscriptions('rejected')" id="tab-sub-rejected" class="pb-4 px-2 tab-inactive">
    Ditolak
    <span class="ml-2 bg-red-100 text-red-800 text-xs px-2.5 py-1 rounded-full font-semibold" id="count-sub-rejected">0</span>
  </button>
</div>


      <!-- Search & Filter -->
      <div class="mb-6 flex gap-4">
        <div class="flex-1 relative">
          <i class="ri-search-line absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
          <input type="text" id="search" placeholder="Cari nama, email, username..." class="w-full pl-12 pr-5 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-[#7A5AF8]" oninput="filterSellers()">
        </div>
        <select id="filter-date" onchange="filterSellers()" class="px-5 py-3 border rounded-xl">
          <option value="">Semua Tanggal</option>
          <option value="today">Hari ini</option>
          <option value="week">7 Hari Terakhir</option>
          <option value="month">Bulan Ini</option>
        </select>
      </div>

      <!-- Table -->
      <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
              <tr>
                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Seller</th>
                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Kontak</th>
                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Tanggal Daftar</th>
                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Dokumen</th>
                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Status</th>
                <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Aksi</th>
              </tr>
            </thead>
            <tbody id="seller-list"></tbody>
          </table>
        </div>
        <div id="empty-state" class="hidden py-16 text-center">
          <i class="ri-inbox-line text-6xl text-gray-300 mb-4"></i>
          <h3 class="text-xl font-semibold text-gray-600">Tidak ada data</h3>
        </div>
      </div>

      <!-- Table Payment -->
       <div id="payment-table-container" style="display: none;">
  <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
          <tr>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Invoice</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Customer</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Total</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Tanggal Upload</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Bukti</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Status</th>
            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Aksi</th>
          </tr>
        </thead>
        <tbody id="payment-list"></tbody>
      </table>
    </div>
    <div id="payment-empty-state" class="hidden py-16 text-center">
      <i class="ri-inbox-line text-6xl text-gray-300 mb-4"></i>
      <h3 class="text-xl font-semibold text-gray-600">Tidak ada data</h3>
    </div>
  </div>
</div>

<!-- Table Subscription -->
<div id="subscription-table-container" style="display: none;">
  <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
          <tr>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Seller</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Paket</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Harga</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Tanggal Upload</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Bukti</th>
            <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Status</th>
            <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700">Aksi</th>
          </tr>
        </thead>
        <tbody id="subscription-list"></tbody>
      </table>
    </div>
    <div id="subscription-empty-state" class="hidden py-16 text-center">
      <i class="ri-inbox-line text-6xl text-gray-300 mb-4"></i>
      <h3 class="text-xl font-semibold text-gray-600">Tidak ada data</h3>
    </div>
  </div>
</div>

      <!-- Pagination -->
      <div class="mt-6 flex justify-between items-center">
        <div class="text-sm text-gray-500">Menampilkan <span id="showing-count">0</span> dari <span id="total-count">0</span> data</div>
        <div class="flex gap-2" id="pagination-numbers"></div>
      </div>
    </div>
  </div>

 <!-- Modal Detail -->
<div id="modal" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto animate-slide-in">
    <div class="sticky top-0 bg-white border-b px-8 py-6 flex justify-between items-center z-10">
      <div>
        <h3 class="text-2xl font-bold">Detail & Verifikasi Seller</h3>
        <p class="text-sm text-gray-500 mt-1">Periksa data dengan teliti</p>
      </div>
      <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
        <i class="ri-close-line text-3xl"></i>
      </button>
    </div>
    
    <div class="p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Data Diri -->
        <div class="space-y-5">
          <h4 class="font-bold text-lg border-b pb-3 flex items-center gap-2">
            <i class="ri-user-line text-[#7A5AF8]"></i> Data Diri
          </h4>
          <div>
            <p class="text-sm text-gray-500">Nama Lengkap</p>
            <p class="font-semibold text-lg" id="modal-name">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Username</p>
            <p class="font-semibold" id="modal-username">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Email</p>
            <p class="font-semibold" id="modal-email">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">No. Telepon</p>
            <p class="font-semibold" id="modal-phone">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Tanggal Daftar</p>
            <p class="font-semibold" id="modal-date">-</p>
          </div>
        </div>

        <!-- Foto KTP -->
        <div>
          <h4 class="font-bold text-lg border-b pb-3 mb-4 flex items-center gap-2">
            <i class="ri-id-card-line text-[#7A5AF8]"></i> Foto KTP
          </h4>
          <div class="border-2 border-dashed border-gray-200 rounded-xl overflow-hidden bg-gray-50 relative group">
            <img id="modal-ktp" src="" alt="KTP" class="w-full cursor-pointer hover:opacity-90 transition-opacity" onclick="openZoomModal()">
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all flex items-center justify-center">
              <i class="ri-zoom-in-line text-4xl text-white opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-3 text-center flex items-center justify-center gap-2">
            <i class="ri-information-line"></i> Klik gambar untuk memperbesar
          </p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div id="action-buttons" class="flex gap-4">
        <button onclick="verifySeller(currentSellerId, 'verified')" 
                class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-all">
          <i class="ri-checkbox-circle-line text-2xl"></i> Verifikasi Seller
        </button>
        <button onclick="showRejectReason()" 
                class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-all">
          <i class="ri-close-circle-line text-2xl"></i> Tolak Pendaftaran
        </button>
      </div>

      <!-- Reject Reason Form -->
      <div id="reject-reason" class="mt-6 hidden">
        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6">
          <label class="block text-sm font-semibold text-gray-700 mb-3">
            Alasan Penolakan <span class="text-red-500">*</span>
          </label>
          <textarea id="reject-textarea" 
                    class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-400 focus:ring-2 focus:ring-red-200 outline-none" 
                    rows="4" 
                    placeholder="Contoh: Foto KTP buram / Data tidak sesuai / Dokumen tidak lengkap..."></textarea>
          <div class="mt-4 flex gap-3">
            <button onclick="verifySeller(currentSellerId, 'rejected')" 
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all">
              <i class="ri-send-plane-fill"></i> Konfirmasi Tolak
            </button>
            <button onclick="hideRejectReason()" 
                    class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl font-semibold transition-all">
              Batal
            </button>
          </div>
        </div>
      </div>

      <!-- Info jika sudah diverifikasi/ditolak -->
      <div id="verified-info" class="hidden mt-6 bg-green-50 border-2 border-green-200 rounded-xl p-6">
        <div class="flex items-center gap-3 mb-2">
          <i class="ri-checkbox-circle-fill text-3xl text-green-600"></i>
          <h4 class="font-bold text-green-800">Seller Sudah Diverifikasi</h4>
        </div>
        <p class="text-sm text-gray-600" id="verified-date">-</p>
      </div>

      <div id="rejected-info" class="hidden mt-6 bg-red-50 border-2 border-red-200 rounded-xl p-6">
        <div class="flex items-center gap-3 mb-2">
          <i class="ri-close-circle-fill text-3xl text-red-600"></i>
          <h4 class="font-bold text-red-800">Seller Ditolak</h4>
        </div>
        <p class="text-sm text-gray-600 mb-2"><strong>Alasan:</strong></p>
        <p class="text-sm text-gray-700 bg-white p-3 rounded-lg" id="rejected-reason">-</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detail Payment -->
<div id="modal-payment" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto animate-slide-in">
    <div class="sticky top-0 bg-white border-b px-8 py-6 flex justify-between items-center z-10">
      <div>
        <h3 class="text-2xl font-bold">Detail Pembayaran</h3>
        <p class="text-sm text-gray-500 mt-1" id="modal-payment-invoice">-</p>
      </div>
      <button onclick="closePaymentModal()" class="text-gray-400 hover:text-gray-600">
        <i class="ri-close-line text-3xl"></i>
      </button>
    </div>
    
    <div class="p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Info Transaksi -->
        <div class="space-y-5">
          <h4 class="font-bold text-lg border-b pb-3 flex items-center gap-2">
            <i class="ri-shopping-cart-line text-[#7A5AF8]"></i> Info Transaksi
          </h4>
          <div>
            <p class="text-sm text-gray-500">Customer</p>
            <p class="font-semibold text-lg" id="modal-payment-customer">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Total Pembayaran</p>
            <p class="font-bold text-2xl text-[#7A5AF8]" id="modal-payment-total">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Metode Pembayaran</p>
            <p class="font-semibold capitalize" id="modal-payment-method">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Tanggal Upload Bukti</p>
            <p class="font-semibold" id="modal-payment-date">-</p>
          </div>
          
          <!-- Items List -->
          <div class="mt-6">
            <h5 class="font-semibold mb-3">Detail Produk:</h5>
            <div id="modal-payment-items" class="space-y-2 max-h-60 overflow-y-auto">
              <!-- Items akan dimuat dinamis -->
            </div>
          </div>
        </div>

        <!-- Bukti Pembayaran -->
        <div>
          <h4 class="font-bold text-lg border-b pb-3 mb-4 flex items-center gap-2">
            <i class="ri-image-line text-[#7A5AF8]"></i> Bukti Pembayaran
          </h4>
          <div class="border-2 border-dashed border-gray-200 rounded-xl overflow-hidden bg-gray-50 relative group">
            <img id="modal-payment-proof" src="" alt="Bukti" class="w-full cursor-pointer hover:opacity-90 transition-opacity" onclick="openZoomPaymentModal()">
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all flex items-center justify-center">
              <i class="ri-zoom-in-line text-4xl text-white opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-3 text-center flex items-center justify-center gap-2">
            <i class="ri-information-line"></i> Klik gambar untuk memperbesar
          </p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div id="payment-action-buttons" class="flex gap-4">
        <button onclick="verifyPayment(currentPaymentId, 'verified')" 
                class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-all">
          <i class="ri-checkbox-circle-line text-2xl"></i> Verifikasi Pembayaran
        </button>
        <button onclick="showPaymentRejectReason()" 
                class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-all">
          <i class="ri-close-circle-line text-2xl"></i> Tolak Pembayaran
        </button>
      </div>

      <!-- Reject Reason Form -->
      <div id="payment-reject-reason" class="mt-6 hidden">
        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6">
          <label class="block text-sm font-semibold text-gray-700 mb-3">
            Alasan Penolakan <span class="text-red-500">*</span>
          </label>
          <textarea id="payment-reject-textarea" 
                    class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-400 focus:ring-2 focus:ring-red-200 outline-none" 
                    rows="4" 
                    placeholder="Contoh: Bukti tidak jelas / Nominal tidak sesuai / Bank berbeda..."></textarea>
          <div class="mt-4 flex gap-3">
            <button onclick="verifyPayment(currentPaymentId, 'rejected')" 
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all">
              <i class="ri-send-plane-fill"></i> Konfirmasi Tolak
            </button>
            <button onclick="hidePaymentRejectReason()" 
                    class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl font-semibold transition-all">
              Batal
            </button>
          </div>
        </div>
      </div>

      <!-- Status Info -->
      <div id="payment-verified-info" class="hidden mt-6 bg-green-50 border-2 border-green-200 rounded-xl p-6">
        <div class="flex items-center gap-3">
          <i class="ri-checkbox-circle-fill text-3xl text-green-600"></i>
          <h4 class="font-bold text-green-800">Pembayaran Sudah Diverifikasi</h4>
        </div>
      </div>

      <div id="payment-rejected-info" class="hidden mt-6 bg-red-50 border-2 border-red-200 rounded-xl p-6">
        <div class="flex items-center gap-3 mb-2">
          <i class="ri-close-circle-fill text-3xl text-red-600"></i>
          <h4 class="font-bold text-red-800">Pembayaran Ditolak</h4>
        </div>
        <p class="text-sm text-gray-600 mb-2"><strong>Alasan:</strong></p>
        <p class="text-sm text-gray-700 bg-white p-3 rounded-lg" id="payment-rejected-reason">-</p>
      </div>
    </div>
  </div>
</div>

<!-- Zoom Modal Payment -->
<div id="zoom-modal-payment" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-[60] p-8" onclick="closeZoomPaymentModal()">
  <img id="zoomed-payment-proof" class="max-w-full max-h-full rounded-xl" src="" alt="">
</div>

  <!-- Zoom Modal -->
  <div id="zoom-modal" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-[60] p-8" onclick="closeZoomModal()">
    <img id="zoomed-ktp" class="max-w-full max-h-full rounded-xl" src="" alt="">
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed top-4 right-4 bg-white rounded-xl shadow-2xl p-4 z-50 hidden animate-slide-in min-w-[320px]">
    <div class="flex items-center gap-3">
      <div id="toast-icon" class="w-10 h-10 rounded-lg flex items-center justify-center text-white"></div>
      <div>
        <h4 id="toast-title" class="font-semibold"></h4>
        <p id="toast-message" class="text-sm text-gray-600"></p>
      </div>
    </div>
  </div>

  <!-- Modal Detail Subscription -->
<div id="modal-subscription" class="fixed inset-0 bg-black bg-opacity-50 modal-backdrop hidden items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-slide-in">
    <div class="sticky top-0 bg-white border-b px-8 py-6 flex justify-between items-center z-10">
      <div>
        <h3 class="text-2xl font-bold">Detail Subscription</h3>
        <p class="text-sm text-gray-500 mt-1" id="modal-sub-store">-</p>
      </div>
      <button onclick="closeSubscriptionModal()" class="text-gray-400 hover:text-gray-600">
        <i class="ri-close-line text-3xl"></i>
      </button>
    </div>
    
    <div class="p-8">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Info Subscription -->
        <div class="space-y-5">
          <h4 class="font-bold text-lg border-b pb-3 flex items-center gap-2">
            <i class="ri-vip-crown-line text-[#7A5AF8]"></i> Info Paket
          </h4>
          <div>
            <p class="text-sm text-gray-500">Nama Toko</p>
            <p class="font-semibold text-lg" id="modal-sub-storename">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Pemilik</p>
            <p class="font-semibold" id="modal-sub-seller">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Email</p>
            <p class="font-semibold" id="modal-sub-email">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Paket Dipilih</p>
            <p class="font-bold text-2xl text-[#7A5AF8] uppercase" id="modal-sub-package">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Durasi</p>
            <p class="font-semibold" id="modal-sub-duration">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Total Pembayaran</p>
            <p class="font-bold text-2xl text-gray-900" id="modal-sub-total">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Metode Pembayaran</p>
            <p class="font-semibold capitalize" id="modal-sub-method">-</p>
          </div>
          <div>
            <p class="text-sm text-gray-500">Tanggal Upload Bukti</p>
            <p class="font-semibold" id="modal-sub-date">-</p>
          </div>
        </div>

        <!-- Bukti Pembayaran -->
        <div>
          <h4 class="font-bold text-lg border-b pb-3 mb-4 flex items-center gap-2">
            <i class="ri-image-line text-[#7A5AF8]"></i> Bukti Pembayaran
          </h4>
          <div class="border-2 border-dashed border-gray-200 rounded-xl overflow-hidden bg-gray-50 relative group">
            <img id="modal-sub-proof" src="" alt="Bukti" class="w-full cursor-pointer hover:opacity-90 transition-opacity" onclick="openZoomSubscriptionModal()">
            <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all flex items-center justify-center">
              <i class="ri-zoom-in-line text-4xl text-white opacity-0 group-hover:opacity-100 transition-opacity"></i>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-3 text-center flex items-center justify-center gap-2">
            <i class="ri-information-line"></i> Klik gambar untuk memperbesar
          </p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div id="subscription-action-buttons" class="flex gap-4">
        <button onclick="verifySubscription(currentSubscriptionId, 'verified')" 
                class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-all">
          <i class="ri-checkbox-circle-line text-2xl"></i> Verifikasi Subscription
        </button>
        <button onclick="showSubscriptionRejectReason()" 
                class="flex-1 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-all">
          <i class="ri-close-circle-line text-2xl"></i> Tolak Subscription
        </button>
      </div>

      <!-- Reject Reason Form -->
      <div id="subscription-reject-reason" class="mt-6 hidden">
        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6">
          <label class="block text-sm font-semibold text-gray-700 mb-3">
            Alasan Penolakan <span class="text-red-500">*</span>
          </label>
          <textarea id="subscription-reject-textarea" 
                    class="w-full px-4 py-3 border-2 border-red-200 rounded-xl focus:border-red-400 focus:ring-2 focus:ring-red-200 outline-none" 
                    rows="4" 
                    placeholder="Contoh: Bukti tidak jelas / Nominal tidak sesuai / Transfer tidak valid..."></textarea>
          <div class="mt-4 flex gap-3">
            <button onclick="verifySubscription(currentSubscriptionId, 'rejected')" 
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition-all">
              <i class="ri-send-plane-fill"></i> Konfirmasi Tolak
            </button>
            <button onclick="hideSubscriptionRejectReason()" 
                    class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-xl font-semibold transition-all">
              Batal
            </button>
          </div>
        </div>
      </div>

      <!-- Status Info -->
      <div id="subscription-verified-info" class="hidden mt-6 bg-green-50 border-2 border-green-200 rounded-xl p-6">
        <div class="flex items-center gap-3">
          <i class="ri-checkbox-circle-fill text-3xl text-green-600"></i>
          <div>
            <h4 class="font-bold text-green-800">Subscription Aktif</h4>
            <p class="text-sm text-gray-600 mt-1" id="subscription-period">-</p>
          </div>
        </div>
      </div>

      <div id="subscription-rejected-info" class="hidden mt-6 bg-red-50 border-2 border-red-200 rounded-xl p-6">
        <div class="flex items-center gap-3 mb-2">
          <i class="ri-close-circle-fill text-3xl text-red-600"></i>
          <h4 class="font-bold text-red-800">Subscription Ditolak</h4>
        </div>
        <p class="text-sm text-gray-600 mb-2"><strong>Alasan:</strong></p>
        <p class="text-sm text-gray-700 bg-white p-3 rounded-lg" id="subscription-rejected-reason">-</p>
      </div>
    </div>
  </div>
</div>

<!-- Zoom Modal Subscription -->
<div id="zoom-modal-subscription" class="fixed inset-0 bg-black bg-opacity-90 hidden items-center justify-center z-[60] p-8" onclick="closeZoomSubscriptionModal()">
  <img id="zoomed-subscription-proof" class="max-w-full max-h-full rounded-xl" src="" alt="">
</div>

<script>
let allSellers = [];
let filteredSellers = [];
let currentStatus = 'pending';
let currentPage = 1;
const itemsPerPage = 10;
let currentSellerId = null;
let currentMenu = 'seller';
let currentPaymentId = null;
let allPayments = [];
let filteredPayments = [];

// Cek login admin
if (!localStorage.getItem('adminLoggedIn')) {
  window.location.href = 'loginAdmin.html';
}

document.addEventListener('DOMContentLoaded', () => {
  updateCurrentDate();
  loadSellers('pending');
  setInterval(updateCurrentDate, 60000);
});

function updateCurrentDate() {
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
  document.getElementById('current-date').textContent = new Date().toLocaleDateString('id-ID', options);
}

async function loadSellers(status) {
  currentStatus = status;
  
  try {
    const searchQuery = document.getElementById('search').value;
    const dateFilter = document.getElementById('filter-date').value;
    
    const response = await fetch(`backend/api/get_sellers.php?status=${status}&search=${searchQuery}&date_filter=${dateFilter}`);
    const result = await response.json();

    if (result.success) {
      allSellers = result.data;
      document.querySelectorAll('[id^="tab-"]').forEach(t => {
        t.classList.remove('tab-active');
        t.classList.add('tab-inactive');
      });
      document.getElementById(`tab-${status}`).classList.remove('tab-inactive');
      document.getElementById(`tab-${status}`).classList.add('tab-active');
      
      filterSellers();
      updateStats();
    }
  } catch (error) {
    console.error('Error loading sellers:', error);
    showToast('error', 'Error', 'Gagal memuat data seller');
  }
}

function filterSellers() {
  filteredSellers = allSellers;
  currentPage = 1;
  renderTable();
  renderPagination();
}

function renderTable() {
  const tbody = document.getElementById('seller-list');
  const emptyState = document.getElementById('empty-state');
  tbody.innerHTML = '';
  
  const start = (currentPage - 1) * itemsPerPage;
  const pageData = filteredSellers.slice(start, start + itemsPerPage);

  if (pageData.length === 0) {
    emptyState.classList.remove('hidden');
    document.getElementById('showing-count').textContent = '0';
    document.getElementById('total-count').textContent = '0';
    return;
  } else {
    emptyState.classList.add('hidden');
  }

  pageData.forEach(s => {
    const statusLabel = s.status === 'pending' ? 'Menunggu' : 
                        s.status === 'verified' ? 'Terverifikasi' : 'Ditolak';
    
    const hasKtp = s.ktp_photo && s.ktp_photo !== '';
    
    const ktpButton = hasKtp 
      ? `<button onclick='openModal(${JSON.stringify(s).replace(/'/g, "\\'")})'  class="text-[#7A5AF8] hover:underline font-medium">
           <i class="ri-image-line"></i> Lihat KTP
         </button>`
      : `<span class="text-gray-400 text-sm">Tidak ada foto</span>`;
    
const actionButton = (s.status === 'pending' && hasKtp)
    ? `<button onclick='openModal(${JSON.stringify(s).replace(/'/g, "\\'")})'
             class="text-white bg-[#7A5AF8] hover:bg-[#6346E8] px-4 py-2 rounded-lg font-medium transition-all">
       <i class="ri-check-line"></i> Verifikasi
     </button>`
    : `<span class="text-gray-400">-</span>`;
    
    const row = `
      <tr class="border-b hover:bg-gray-50 transition-colors">
        <td class="px-6 py-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-br from-[#7A5AF8] to-[#9B7EF9] rounded-full flex items-center justify-center text-white font-bold">
              ${s.first_name.charAt(0)}${s.last_name.charAt(0)}
            </div>
            <div>
              <div class="font-medium text-gray-900">${s.first_name} ${s.last_name}</div>
              <div class="text-sm text-gray-500">@${s.username}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 text-sm">
          <div class="flex items-center gap-2 mb-1">
            <i class="ri-mail-line text-gray-400"></i>
            <span>${s.email}</span>
          </div>
          <div class="flex items-center gap-2">
            <i class="ri-phone-line text-gray-400"></i>
            <span>${s.phone || '-'}</span>
          </div>
        </td>
        <td class="px-6 py-4 text-sm text-gray-600">
          ${new Date(s.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}
        </td>
        <td class="px-6 py-4">${ktpButton}</td>
        <td class="px-6 py-4">
          <span class="px-3 py-1 rounded-full text-xs font-medium status-${s.status}">
            ${statusLabel}
          </span>
        </td>
        <td class="px-6 py-4 text-center">${actionButton}</td>
      </tr>`;
    
    tbody.innerHTML += row;
  });

  document.getElementById('showing-count').textContent = pageData.length;
  document.getElementById('total-count').textContent = filteredSellers.length;
}

function renderPagination() {
  const total = Math.ceil(filteredSellers.length / itemsPerPage);
  const cont = document.getElementById('pagination-numbers');
  cont.innerHTML = '';
  for(let i=1;i<=total;i++){
    cont.innerHTML += `<button onclick="currentPage=${i};renderTable();renderPagination()" class="px-4 py-2 rounded-lg ${i===currentPage?'bg-[#7A5AF8] text-white':'bg-gray-100 hover:bg-gray-200'}">${i}</button>`;
  }
}

async function updateStats() {
  try {
    const statuses = ['pending', 'verified', 'rejected'];
    for (const st of statuses) {
      const resp = await fetch(`backend/api/get_sellers.php?status=${st}`);
      const data = await resp.json();
      const count = data.success ? data.data.length : 0;
      
      document.getElementById(`stat-${st}`).textContent = count;
      document.getElementById(`count-${st}`).textContent = count;
      document.getElementById(`sidebar-${st}`).textContent = count;
    }

    const totalResp = await fetch(`backend/api/get_sellers.php?status=all`);
    const totalData = await totalResp.json();
    document.getElementById('stat-total').textContent = totalData.success ? totalData.data.length : 0;
  } catch (error) {
    console.error('Error updating stats:', error);
  }
}

function openModal(seller) {
  currentSellerId = seller.id;
  
  let ktpPath;
  
  if (seller.ktp_photo && seller.ktp_photo !== '') {
    ktpPath = `backend/${seller.ktp_photo}`;
    console.log('KTP Photo from DB:', seller.ktp_photo);
    console.log('Final KTP Path:', ktpPath);
  } else {
    ktpPath = 'https://via.placeholder.com/800x500/cccccc/666666?text=Foto+KTP+Tidak+Tersedia';
  }
  
  document.getElementById('modal-name').textContent = `${seller.first_name} ${seller.last_name}`;
  document.getElementById('modal-email').textContent = seller.email;
  document.getElementById('modal-username').textContent = '@' + seller.username;
  document.getElementById('modal-phone').textContent = seller.phone || '-';
  document.getElementById('modal-date').textContent = new Date(seller.created_at).toLocaleDateString('id-ID', {
    weekday: 'long',
    day: 'numeric',
    month: 'long',
    year: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
  
  const ktpImg = document.getElementById('modal-ktp');
  ktpImg.src = ktpPath;
  
  ktpImg.onerror = function() {
    console.error('Failed to load image:', ktpPath);
    this.src = 'https://via.placeholder.com/800x500/ff6b6b/ffffff?text=Foto+KTP+Gagal+Dimuat';
  };
  
  document.getElementById('reject-reason').classList.add('hidden');
  document.getElementById('reject-textarea').value = '';
  
  const actionButtons = document.getElementById('action-buttons');
  const verifiedInfo = document.getElementById('verified-info');
  const rejectedInfo = document.getElementById('rejected-info');
  
  actionButtons.classList.add('hidden');
  verifiedInfo.classList.add('hidden');
  rejectedInfo.classList.add('hidden');
  
  if (seller.status === 'pending') {
    actionButtons.classList.remove('hidden');
  } else if (seller.status === 'verified') {
    verifiedInfo.classList.remove('hidden');
    if (seller.verified_at) {
      document.getElementById('verified-date').textContent = 
        `Diverifikasi pada: ${new Date(seller.verified_at).toLocaleDateString('id-ID', {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })}`;
    }
  } else if (seller.status === 'rejected') {
    rejectedInfo.classList.remove('hidden');
    document.getElementById('rejected-reason').textContent = seller.rejection_reason || '-';
  }
  
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('modal').classList.add('flex');
}

function closeModal(){ 
  document.getElementById('modal').classList.add('hidden');
  document.getElementById('modal').classList.remove('flex');
}

function showRejectReason(){ 
  document.getElementById('reject-reason').classList.remove('hidden'); 
}

function hideRejectReason(){ 
  document.getElementById('reject-reason').classList.add('hidden'); 
}

async function verifySeller(id, action) {
  const rejectionReason = document.getElementById('reject-textarea').value.trim();
  
  if(action==='rejected' && !rejectionReason) {
    showToast('error','Gagal','Alasan penolakan wajib diisi!');
    return;
  }

  try {
    const response = await fetch('backend/api/verify_seller.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        seller_id: id,
        action: action,
        rejection_reason: rejectionReason
      })
    });

    const result = await response.json();

    if (result.success) {
      closeModal();
      loadSellers(currentStatus);
      showToast('success', 'Sukses', result.message);
    } else {
      showToast('error', 'Gagal', result.message);
    }
  } catch (error) {
    console.error('Error:', error);
    showToast('error', 'Error', 'Terjadi kesalahan sistem');
  }
}

function openZoomModal(){ 
  document.getElementById('zoomed-ktp').src = document.getElementById('modal-ktp').src;
  document.getElementById('zoom-modal').classList.remove('hidden');
  document.getElementById('zoom-modal').classList.add('flex');
}

function closeZoomModal(){ 
  document.getElementById('zoom-modal').classList.add('hidden');
  document.getElementById('zoom-modal').classList.remove('flex');
}

function showToast(type, title, msg){
  document.getElementById('toast-title').textContent = title;
  document.getElementById('toast-message').textContent = msg;
  const icon = type==='success' ? '<i class="ri-checkbox-circle-line text-2xl"></i>' : '<i class="ri-close-circle-line text-2xl"></i>';
  document.getElementById('toast-icon').innerHTML = icon;
  document.getElementById('toast-icon').className = `w-10 h-10 rounded-lg flex items-center justify-center text-white ${type==='success'?'bg-green-500':'bg-red-500'}`;
  document.getElementById('toast').classList.remove('hidden');
  setTimeout(()=>document.getElementById('toast').classList.add('hidden'), 4000);
}

function refreshData(){ 
  if (currentMenu === 'seller') {
    loadSellers(currentStatus);
  } else if (currentMenu === 'payment') {
    loadPayments(currentStatus);
  } else if (currentMenu === 'subscription') {
    loadSubscriptions(currentStatus);
  }
  showToast('success','Refresh','Data berhasil diperbarui'); 
}

function logoutAdmin(e) {
  e.preventDefault();
  if (confirm('Yakin ingin logout?')) {
    fetch('backend/api/logout_admin.php')
      .then(() => {
        localStorage.removeItem('adminLoggedIn');
        localStorage.removeItem('adminRemember');
        window.location.href = 'loginAdmin.html';
      });
  }
}

// ==================== PAYMENT VERIFICATION FUNCTIONS ====================

function switchMenu(menu) {
    currentMenu = menu;

    // Reset active menu styling
    document.getElementById('menu-seller').classList.remove('bg-white', 'bg-opacity-20');
    document.getElementById('menu-payment').classList.remove('bg-white', 'bg-opacity-20');
    document.getElementById('menu-subscription').classList.remove('bg-white', 'bg-opacity-20');

    // Elemen seller
    const sellerStats = document.getElementById('seller-stats');
    const sellerTabs = document.getElementById('seller-tabs');
    const sellerCard = document.querySelector('.bg-white.rounded-2xl.shadow-lg');
    const sellerSidebar = document.getElementById('sidebar-seller-stats');

    // Elemen payment
    const paymentStats = document.getElementById('payment-stats');
    const paymentTabs = document.getElementById('payment-tabs');
    const paymentTable = document.getElementById('payment-table-container');
    const paymentSidebar = document.getElementById('sidebar-payment-stats');

    // Elemen subscription
    const subStats = document.getElementById('subscription-stats');
    const subTabs = document.getElementById('subscription-tabs');
    const subTable = document.getElementById('subscription-table-container');
    const subSidebar = document.getElementById('sidebar-subscription-stats');

    // Hide all sections first
    sellerStats.style.display = 'none';
    sellerTabs.style.display = 'none';
    sellerCard.style.display = 'none';
    sellerSidebar.classList.add('hidden');

    paymentStats.style.display = 'none';
    paymentTabs.style.display = 'none';
    paymentTable.style.display = 'none';
    paymentSidebar.classList.add('hidden');

    subStats.style.display = 'none';
    subTabs.style.display = 'none';
    subTable.style.display = 'none';
    subSidebar.classList.add('hidden');

    // Switch logic
    if (menu === 'seller') {
        document.getElementById('menu-seller').classList.add('bg-white', 'bg-opacity-20');
        document.getElementById('page-title').textContent = 'Verifikasi Seller Baru';
        document.getElementById('page-subtitle').textContent = 'Kelola dan verifikasi pendaftaran seller';

        sellerStats.style.display = 'grid';
        sellerTabs.style.display = 'flex';
        sellerCard.style.display = 'block';
        sellerSidebar.classList.remove('hidden');

        loadSellers('pending');

    } else if (menu === 'payment') {
        document.getElementById('menu-payment').classList.add('bg-white', 'bg-opacity-20');
        document.getElementById('page-title').textContent = 'Verifikasi Pembayaran';
        document.getElementById('page-subtitle').textContent = 'Kelola dan verifikasi bukti pembayaran invoice';

        paymentStats.style.display = 'grid';
        paymentTabs.style.display = 'flex';
        paymentTable.style.display = 'block';
        paymentSidebar.classList.remove('hidden');

        loadPayments('pending');

    } else if (menu === 'subscription') {
        document.getElementById('menu-subscription').classList.add('bg-white', 'bg-opacity-20');
        document.getElementById('page-title').textContent = 'Verifikasi Subscription';
        document.getElementById('page-subtitle').textContent = 'Kelola dan verifikasi pembayaran paket premium seller';

        subStats.style.display = 'grid';
        subTabs.style.display = 'flex';
        subTable.style.display = 'block';
        subSidebar.classList.remove('hidden');

        loadSubscriptions('waiting'); // Default waiting
    }
}


async function loadPayments(status) {
  currentStatus = status;
  
  try {
    const searchQuery = document.getElementById('search').value;
    const dateFilter = document.getElementById('filter-date').value;
    
    const url = `backend/api/get_payments.php?status=${status}&search=${searchQuery}&date_filter=${dateFilter}`;
    console.log('Loading payments from:', url);
    
    const response = await fetch(url);
    const result = await response.json();
    
    console.log('Payment response:', result);

    if (result.success) {
      allPayments = result.data;
      console.log('Total payments loaded:', allPayments.length);
      
      document.querySelectorAll('[id^="tab-payment-"]').forEach(t => {
        t.classList.remove('tab-active');
        t.classList.add('tab-inactive');
      });
      document.getElementById(`tab-payment-${status}`).classList.remove('tab-inactive');
      document.getElementById(`tab-payment-${status}`).classList.add('tab-active');
      
      filterPayments();
      updatePaymentStats();
    } else {
      console.error('Error from server:', result.message);
      showToast('error', 'Error', result.message || 'Gagal memuat data pembayaran');
    }
  } catch (error) {
    console.error('Error loading payments:', error);
    showToast('error', 'Error', 'Gagal memuat data pembayaran: ' + error.message);
  }
}

function filterPayments() {
  filteredPayments = allPayments;
  currentPage = 1;
  renderPaymentTable();
  renderPagination();
}

function renderPaymentTable() {
  const tbody = document.getElementById('payment-list');
  const emptyState = document.getElementById('payment-empty-state');
  
  if (!tbody) {
    console.error('payment-list element not found!');
    return;
  }
  
  tbody.innerHTML = '';
  
  const start = (currentPage - 1) * itemsPerPage;
  const pageData = filteredPayments.slice(start, start + itemsPerPage);
  
  console.log('Rendering payments:', pageData.length, 'items');

  if (pageData.length === 0) {
    if (emptyState) emptyState.classList.remove('hidden');
    return;
  } else {
    if (emptyState) emptyState.classList.add('hidden');
  }

  pageData.forEach(p => {
    console.log('Payment item:', p);
    
const statusLabel = p.status === 'pending' ? 'Menunggu Pembayaran' : 
                    p.status === 'waiting' ? 'Menunggu Verifikasi' :
                    p.status === 'verified' ? 'Terverifikasi' : 'Ditolak';

const statusClass = p.status === 'pending' ? 'status-pending' : 
                    p.status === 'waiting' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                    p.status === 'verified' ? 'status-verified' : 'status-rejected';
    
const actionButton = (p.status === 'waiting' && p.payment_proof)
    ? `<button onclick='openPaymentModal(${JSON.stringify(p).replace(/'/g, "\\'")})'
                 class="text-white bg-[#7A5AF8] hover:bg-[#6346E8] px-4 py-2 rounded-lg font-medium transition-all">
           <i class="ri-check-line"></i> Verifikasi
         </button>`
      : `<span class="text-gray-400">-</span>`;
    
    const row = `
      <tr class="border-b hover:bg-gray-50 transition-colors">
        <td class="px-6 py-4">
          <div class="font-semibold text-[#7A5AF8]">${p.invoice_number}</div>
          <div class="text-xs text-gray-500">${p.total_items || 0} item</div>
        </td>
        <td class="px-6 py-4">
          <div class="font-medium">${p.customer_name}</div>
          <div class="text-sm text-gray-500">${p.customer_email}</div>
        </td>
        <td class="px-6 py-4 font-bold text-gray-900">
          Rp ${Number(p.grand_total).toLocaleString('id-ID')}
        </td>
        <td class="px-6 py-4 text-sm text-gray-600">
          ${p.updated_at ? new Date(p.updated_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}
        </td>
        <td class="px-6 py-4">
          ${p.payment_proof ? `<button onclick='openPaymentModal(${JSON.stringify(p).replace(/'/g, "\\'")})' class="text-[#7A5AF8] hover:underline font-medium">
            <i class="ri-image-line"></i> Lihat Bukti
          </button>` : '<span class="text-gray-400 text-sm">Belum upload</span>'}
        </td>
        <td class="px-6 py-4">
          <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${statusLabel}
          </span>
        </td>
        <td class="px-6 py-4 text-center">${actionButton}</td>
      </tr>`;
    
    tbody.innerHTML += row;
  });
}

async function updatePaymentStats() {
  try {
    const statuses = ['pending', 'waiting', 'verified', 'rejected']; // HAPUS 'completed'
    for (const st of statuses) {
      const resp = await fetch(`backend/api/get_payments.php?status=${st}`);
      const data = await resp.json();
      const count = data.success ? data.data.length : 0;
      
      const statEl = document.getElementById(`stat-payment-${st}`);
      const countEl = document.getElementById(`count-payment-${st}`);
      
      if (statEl) statEl.textContent = count;
      if (countEl) countEl.textContent = count;
      
      const sidebarEl = document.getElementById(`sidebar-payment-${st}`);
      if (sidebarEl) sidebarEl.textContent = count;
    }

    const totalResp = await fetch(`backend/api/get_payments.php?status=all`);
    const totalData = await totalResp.json();
    const totalEl = document.getElementById('stat-payment-total');
    if (totalEl) {
      totalEl.textContent = totalData.success ? totalData.data.length : 0;
    }
  } catch (error) {
    console.error('Error updating payment stats:', error);
  }
}

// Ganti fungsi openPaymentModal dengan ini:
function openPaymentModal(payment) {
  currentPaymentId = payment.id;
  
  document.getElementById('modal-payment-invoice').textContent = payment.invoice_number;
  document.getElementById('modal-payment-customer').textContent = payment.customer_name;
  document.getElementById('modal-payment-total').textContent = 'Rp ' + Number(payment.grand_total).toLocaleString('id-ID');
  document.getElementById('modal-payment-method').textContent = payment.payment_method;
  document.getElementById('modal-payment-date').textContent = payment.updated_at ? 
    new Date(payment.updated_at).toLocaleDateString('id-ID', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    }) : '-';
  
  // Render items
  const itemsHtml = JSON.parse(payment.items || '[]').map(item => {
    // Foto produk ada di assets/img (TIDAK pakai prefix backend/)
    let imagePath = item.product_image || '';
    
    // Jika path kosong, gunakan placeholder
    if (!imagePath) {
      imagePath = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2248%22%3E%3Crect fill=%22%23ddd%22 width=%2248%22 height=%2248%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2212%22%3ENo Image%3C/text%3E%3C/svg%3E';
    }
    
    return `
      <div class="flex items-center gap-3 bg-gray-50 p-3 rounded-lg">
        <img src="${imagePath}" 
             alt="Product" 
             class="w-12 h-12 object-cover rounded" 
             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2248%22 height=%2248%22%3E%3Crect fill=%22%23ddd%22 width=%2248%22 height=%2248%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2212%22%3ENo Image%3C/text%3E%3C/svg%3E';">
        <div class="flex-1">
          <p class="font-medium text-sm">${item.product_name || item.name}</p>
          <p class="text-xs text-gray-500">${item.quantity}x @ Rp ${Number(item.price).toLocaleString('id-ID')}</p>
        </div>
        <p class="font-semibold text-sm">Rp ${Number(item.subtotal).toLocaleString('id-ID')}</p>
      </div>
    `;
  }).join('');
  
  document.getElementById('modal-payment-items').innerHTML = itemsHtml;
  
  // Set bukti pembayaran - uploads/payments TIDAK di dalam folder backend
  let proofPath = '';
  if (payment.payment_proof && payment.payment_proof !== '') {
    // Path dari PHP sudah: uploads/payments/payment_X.jpg
    // Dari admin.html, cukup gunakan langsung (karena uploads sejajar dengan admin.html)
    proofPath = payment.payment_proof;
  } else {
    proofPath = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22500%22%3E%3Crect fill=%22%23cccccc%22 width=%22800%22 height=%22500%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666666%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2224%22%3EBukti Belum Upload%3C/text%3E%3C/svg%3E';
  }
  
  const proofImg = document.getElementById('modal-payment-proof');
  proofImg.src = proofPath;
  
  proofImg.onerror = function() {
    console.error('Failed to load payment proof:', proofPath);
    this.onerror = null;
    this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22500%22%3E%3Crect fill=%22%23ff6b6b%22 width=%22800%22 height=%22500%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23ffffff%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2224%22%3EGagal Memuat Bukti%3C/text%3E%3C/svg%3E';
  };
  
  document.getElementById('payment-reject-reason').classList.add('hidden');
  document.getElementById('payment-reject-textarea').value = '';
  
  const actionButtons = document.getElementById('payment-action-buttons');
  const verifiedInfo = document.getElementById('payment-verified-info');
  const rejectedInfo = document.getElementById('payment-rejected-info');
  
  actionButtons.classList.add('hidden');
  verifiedInfo.classList.add('hidden');
  rejectedInfo.classList.add('hidden');
  
if (payment.status === 'waiting' && payment.payment_proof) {
    // Kalau status waiting (sudah upload bukti, menunggu verifikasi), tampilkan tombol aksi
    actionButtons.classList.remove('hidden');
} else if (payment.status === 'verified') {
    verifiedInfo.classList.remove('hidden');
} else if (payment.status === 'rejected') {
    rejectedInfo.classList.remove('hidden');
    document.getElementById('payment-rejected-reason').textContent = payment.admin_note || '-';
}
  
  document.getElementById('modal-payment').classList.remove('hidden');
  document.getElementById('modal-payment').classList.add('flex');
}


function closePaymentModal() {
  document.getElementById('modal-payment').classList.add('hidden');
  document.getElementById('modal-payment').classList.remove('flex');
}

function showPaymentRejectReason() {
  document.getElementById('payment-reject-reason').classList.remove('hidden');
}

function hidePaymentRejectReason() {
  document.getElementById('payment-reject-reason').classList.add('hidden');
}

async function verifyPayment(id, action) {
  const rejectionReason = document.getElementById('payment-reject-textarea').value.trim();
  
  if (action === 'rejected' && !rejectionReason) {
    showToast('error', 'Gagal', 'Alasan penolakan wajib diisi!');
    return;
  }

  try {
    const response = await fetch('backend/api/verify_payment.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        invoice_id: id,
        action: action,
        rejection_reason: rejectionReason
      })
    });

    const result = await response.json();

    if (result.success) {
      closePaymentModal();
      loadPayments(currentStatus);
      showToast('success', 'Sukses', result.message);
    } else {
      showToast('error', 'Gagal', result.message);
    }
  } catch (error) {
    console.error('Error:', error);
    showToast('error', 'Error', 'Terjadi kesalahan sistem');
  }
}

function openZoomPaymentModal() {
  document.getElementById('zoomed-payment-proof').src = document.getElementById('modal-payment-proof').src;
  document.getElementById('zoom-modal-payment').classList.remove('hidden');
  document.getElementById('zoom-modal-payment').classList.add('flex');
}

function closeZoomPaymentModal() {
  document.getElementById('zoom-modal-payment').classList.add('hidden');
  document.getElementById('zoom-modal-payment').classList.remove('flex');
}

let allSubscriptions = [];
let filteredSubscriptions = [];
let currentSubscriptionId = null;

// Load Subscriptions
async function loadSubscriptions(status) {
  currentStatus = status;
  
  try {
    const searchQuery = document.getElementById('search').value;
    const dateFilter = document.getElementById('filter-date').value;
    
    const url = `backend/api/get_subscriptions.php?status=${status}&search=${searchQuery}&date_filter=${dateFilter}`;
    const response = await fetch(url);
    const result = await response.json();

    if (result.success) {
      allSubscriptions = result.data;
      
      document.querySelectorAll('[id^="tab-sub-"]').forEach(t => {
        t.classList.remove('tab-active');
        t.classList.add('tab-inactive');
      });
      document.getElementById(`tab-sub-${status}`).classList.remove('tab-inactive');
      document.getElementById(`tab-sub-${status}`).classList.add('tab-active');
      
      filterSubscriptions();
      updateSubscriptionStats();
    }
  } catch (error) {
    console.error('Error loading subscriptions:', error);
    showToast('error', 'Error', 'Gagal memuat data subscription');
  }
}

function filterSubscriptions() {
  filteredSubscriptions = allSubscriptions;
  currentPage = 1;
  renderSubscriptionTable();
  renderPagination();
}

function renderSubscriptionTable() {
  const tbody = document.getElementById('subscription-list');
  const emptyState = document.getElementById('subscription-empty-state');
  
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  const start = (currentPage - 1) * itemsPerPage;
  const pageData = filteredSubscriptions.slice(start, start + itemsPerPage);

  if (pageData.length === 0) {
    if (emptyState) emptyState.classList.remove('hidden');
    return;
  } else {
    if (emptyState) emptyState.classList.add('hidden');
  }

  pageData.forEach(s => {
    const statusLabel = s.status === 'pending' ? 'Belum Bayar' : 
                        s.status === 'waiting' ? 'Menunggu Verifikasi' :
                        s.status === 'verified' ? 'Aktif' : 'Ditolak';

    const statusClass = s.status === 'pending' ? 'bg-orange-100 text-orange-800 border border-orange-200' : 
                        s.status === 'waiting' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                        s.status === 'verified' ? 'status-verified' : 'status-rejected';
    
    const packageBadge = {
      'gold': '<span class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold uppercase">Gold</span>',
      'silver': '<span class="bg-gray-400 text-gray-900 px-3 py-1 rounded-full text-xs font-bold uppercase">Silver</span>',
      'bronze': '<span class="bg-orange-600 text-white px-3 py-1 rounded-full text-xs font-bold uppercase">Bronze</span>'
    };
    
    const actionButton = (s.status === 'waiting' && s.payment_proof)
      ? `<button onclick='openSubscriptionModal(${JSON.stringify(s).replace(/'/g, "\\'")})'
                 class="text-white bg-[#7A5AF8] hover:bg-[#6346E8] px-4 py-2 rounded-lg font-medium transition-all">
           <i class="ri-check-line"></i> Verifikasi
         </button>`
      : `<span class="text-gray-400">-</span>`;
    
    const row = `
      <tr class="border-b hover:bg-gray-50 transition-colors">
        <td class="px-6 py-4">
          <div class="flex items-center gap-3">
            <img src="${s.logo ? 'backend/' + s.logo : 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover">
            <div>
              <div class="font-medium">${s.store_name}</div>
              <div class="text-sm text-gray-500">${s.seller_name}</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4">
          ${packageBadge[s.package_tier] || s.package_tier}
          <div class="text-xs text-gray-500 mt-1">${s.duration_months} bulan</div>
        </td>
        <td class="px-6 py-4 font-bold">
          Rp ${Number(s.total_price).toLocaleString('id-ID')}
        </td>
        <td class="px-6 py-4 text-sm text-gray-600">
          ${s.updated_at ? new Date(s.updated_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : '-'}
        </td>
        <td class="px-6 py-4">
          ${s.payment_proof ? `<button onclick='openSubscriptionModal(${JSON.stringify(s).replace(/'/g, "\\'")})' class="text-[#7A5AF8] hover:underline font-medium">
            <i class="ri-image-line"></i> Lihat Bukti
          </button>` : '<span class="text-gray-400 text-sm">Belum upload</span>'}
        </td>
        <td class="px-6 py-4">
          <span class="px-3 py-1 rounded-full text-xs font-medium ${statusClass}">
            ${statusLabel}
          </span>
        </td>
        <td class="px-6 py-4 text-center">${actionButton}</td>
      </tr>`;
    
    tbody.innerHTML += row;
  });
}

async function updateSubscriptionStats() {
  try {
    const statuses = ['pending', 'waiting', 'verified', 'rejected'];
    for (const st of statuses) {
      const resp = await fetch(`backend/api/get_subscriptions.php?status=${st}`);
      const data = await resp.json();
      const count = data.success ? data.data.length : 0;
      
      const statEl = document.getElementById(`stat-sub-${st}`);
      const countEl = document.getElementById(`count-sub-${st}`);
      const sidebarEl = document.getElementById(`sidebar-sub-${st}`);
      
      if (statEl) statEl.textContent = count;
      if (countEl) countEl.textContent = count;
      if (sidebarEl) sidebarEl.textContent = count;
    }
  } catch (error) {
    console.error('Error updating subscription stats:', error);
  }
}

function openSubscriptionModal(subscription) {
    currentSubscriptionId = subscription.id;

    // Set basic info
    document.getElementById('modal-sub-store').textContent = subscription.store_name;
    document.getElementById('modal-sub-storename').textContent = subscription.store_name;
    document.getElementById('modal-sub-seller').textContent = subscription.seller_name;
    document.getElementById('modal-sub-email').textContent = subscription.seller_email;
    document.getElementById('modal-sub-package').textContent = subscription.package_tier.toUpperCase();
    document.getElementById('modal-sub-duration').textContent = subscription.duration_months + ' bulan';
    document.getElementById('modal-sub-total').textContent = 'Rp ' + Number(subscription.total_price).toLocaleString('id-ID');
    document.getElementById('modal-sub-method').textContent = subscription.payment_method || '-';

    // Tanggal update
    document.getElementById('modal-sub-date').textContent = subscription.updated_at
        ? new Date(subscription.updated_at).toLocaleDateString('id-ID', {
            weekday: 'long',
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        })
        : '-';

    // Set bukti pembayaran
    let proofPath = subscription.payment_proof
        ? `uploads/subscription_payments/${subscription.payment_proof}`
        : '';

    if (!proofPath) {
        proofPath =
            'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22500%22%3E%3Crect fill=%22%23cccccc%22 width=%22800%22 height=%22500%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23666666%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2224%22%3EBukti Belum Upload%3C/text%3E%3C/svg%3E';
    }

    const proofImg = document.getElementById('modal-sub-proof');
    proofImg.src = proofPath;

    proofImg.onerror = function () {
        this.onerror = null;
        this.src =
            'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22500%22%3E%3Crect fill=%22%23ff6b6b%22 width=%22800%22 height=%22500%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23ffffff%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2224%22%3EGagal Memuat%3C/text%3E%3C/svg%3E';
    };

    // Reset reject reason
    document.getElementById('subscription-reject-reason').classList.add('hidden');
    document.getElementById('subscription-reject-textarea').value = '';

    // Elemen status
    const actionButtons = document.getElementById('subscription-action-buttons');
    const verifiedInfo = document.getElementById('subscription-verified-info');
    const rejectedInfo = document.getElementById('subscription-rejected-info');

    actionButtons.classList.add('hidden');
    verifiedInfo.classList.add('hidden');
    rejectedInfo.classList.add('hidden');

    // Status Kondisi
    if (subscription.status === 'waiting' && subscription.payment_proof) {
        actionButtons.classList.remove('hidden');

    } else if (subscription.status === 'verified') {
        verifiedInfo.classList.remove('hidden');

        if (subscription.starts_at && subscription.expires_at) {
            document.getElementById('subscription-period').textContent =
                `Aktif: ${new Date(subscription.starts_at).toLocaleDateString('id-ID')} - ` +
                `${new Date(subscription.expires_at).toLocaleDateString('id-ID')}`;
        }

    } else if (subscription.status === 'rejected') {
        rejectedInfo.classList.remove('hidden');
        document.getElementById('subscription-rejected-reason').textContent =
            subscription.admin_note || '-';
    }

    // Tampilkan modal
    const modal = document.getElementById('modal-subscription');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeSubscriptionModal() {
    const modal = document.getElementById('modal-subscription');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

function showSubscriptionRejectReason() {
    document.getElementById('subscription-reject-reason').classList.remove('hidden');
}

function hideSubscriptionRejectReason() {
    document.getElementById('subscription-reject-reason').classList.add('hidden');
}

async function verifySubscription(id, action) {
    const rejectionReason = document.getElementById('subscription-reject-textarea').value.trim();

    if (action === 'rejected' && !rejectionReason) {
        showToast('error', 'Gagal', 'Alasan penolakan wajib diisi!');
        return;
    }

    try {
        const response = await fetch('backend/api/verify_subscription.php', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                subscription_id: id,
                action: action,
                rejection_reason: rejectionReason
            })
        });

        const result = await response.json();

        if (result.success) {
            closeSubscriptionModal();
            loadSubscriptions(currentStatus);
            showToast('success', 'Sukses', result.message);
        } else {
            showToast('error', 'Gagal', result.message);
        }

    } catch (error) {
        console.error('Error:', error);
        showToast('error', 'Error', 'Terjadi kesalahan sistem');
    }
}

function openZoomSubscriptionModal() {
    document.getElementById('zoomed-subscription-proof').src =
        document.getElementById('modal-sub-proof').src;

    const modal = document.getElementById('zoom-modal-subscription');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeZoomSubscriptionModal() {
    const modal = document.getElementById('zoom-modal-subscription');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}

</script>
</body>
</html>