<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Produk - Promora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7A5AF8',
                        'primary-dark': '#6344E6',
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        .product-image {
            width: 110px;
            height: 110px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 2px solid #E5E7EB;
        }
        
        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .product-image .cover-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: #7A5AF8;
            color: white;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        .toggle-switch {
            position: relative;
            width: 56px;
            height: 32px;
            background: #7A5AF8;
            border-radius: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .toggle-switch.off {
            background: #D1D5DB;
        }
        
        .toggle-switch .toggle-slider {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: right 0.3s;
        }
        
        .toggle-switch.off .toggle-slider {
            right: 28px;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #D1FAE5;
            color: #065F46;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-badge .dot {
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 50%;
        }
        
        .danger-zone {
            border: 1px solid #FEE2E2;
            background: #FEF2F2;
            border-radius: 12px;
            padding: 20px;
        }
        
        .stock-input-group {
            position: relative;
        }
        
        .stock-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            background: #7A5AF8;
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .stock-btn:hover {
            background: #6344E6;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex justify-between items-center">
          <a href="index.html" class="flex items-center space-x-2">
            <div class="flex items-center space-x-2">
              <img
                class="h-8 flex items-center justify-center"
                src="./assets/img/Container.png"
                alt=""
              />
            </div>
          </a>

          <!-- Tombol Setting -->
            <a href="#setting">
                <button class="text-gray-600 hover:text-primary transition">
                    <i class="fas fa-cog text-xl"></i>
                </button>
            </a>
            
          </div>
        </div>
      </div>
    </nav>

    <!-- Breadcrumb -->
    <div class="max-w-5xl mx-auto px-6 py-6">
        <div class="flex items-center space-x-2 text-sm text-gray-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            <span>Toko</span>
            <span>›</span>
            <a href="homeSeller.html"><span>Produk Saya</span></a>
            <span>›</span>
            <span class="text-primary font-medium">Edit Produk</span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-5xl mx-auto px-6 pb-20">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-primary mb-2">Edit Produk</h1>
            <p class="text-gray-600">Perbarui informasi produk yang kamu jual.</p>
        </div>

        <div class="bg-white rounded-2xl shadow-sm p-8">
            <form id="editProductForm">
                <!-- Foto Produk -->
                <div class="mb-6">
                    <label class="block text-gray-800 font-semibold mb-3">Foto Produk</label>
                    <div class="flex items-center gap-4 mb-3">
                        <!-- Images will be populated here by JavaScript -->
                    </div>
                    <button type="button" id="changePhotoBtn" class="px-4 py-2 text-primary border border-primary rounded-lg hover:bg-purple-50 transition flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span>Tambah Foto Produk</span>
                    </button>
                    <input type="file" id="fileInput" class="hidden" accept="image/jpeg,image/png">
                    <p class="text-gray-500 text-sm mt-2">Klik foto untuk menggantinya, atau klik "Tambah Foto" untuk menambah foto baru (maksimal 5 foto)</p>
                </div>

                <!-- Nama Produk -->
                <div class="mb-6">
                    <label class="block text-gray-800 font-semibold mb-3">Nama Produk</label>
                    <input type="text" id="productName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50">
                </div>

                <!-- Brand/Merek -->
                <div class="mb-6">
                    <label class="block text-gray-800 font-semibold mb-3">Brand / Merek</label>
                    <input type="text" id="brand" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50">
                </div>

                <!-- Harga Original dan Diskon -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-800 font-semibold mb-3">Harga Original</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-gray-500">Rp</span>
                            <input type="text" id="originalPrice" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50">
                        </div>
                        <p class="text-gray-500 text-sm mt-2">Harga sebelum diskon</p>
                    </div>
                    <div>
                        <label class="block text-gray-800 font-semibold mb-3">Diskon (%)</label>
                        <input type="number" id="discount" min="0" max="100" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50" placeholder="0">
                        <p class="text-gray-500 text-sm mt-2">Persentase diskon dari harga original</p>
                    </div>
                </div>

                <!-- Harga dan Fee -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-800 font-semibold mb-3">Harga Promo</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-gray-500">Rp</span>
                            <input type="text" id="price" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-800 font-semibold mb-3">Fee Jastip</label>
                        <div class="relative">
                            <span class="absolute left-4 top-3 text-gray-500">Rp</span>
                            <input type="text" id="fee" class="w-full pl-12 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50">
                        </div>
                        <p class="text-gray-500 text-sm mt-2">Fee jastip akan muncul di harga total pembeli</p>
                    </div>
                </div>

                <!-- Stok dan Kategori -->
                <div class="grid grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-800 font-semibold mb-3">Kuota Barang</label>
                        <div class="stock-input-group">
                            <input type="number" id="stock" class="w-full px-4 py-3 pr-14 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-gray-50">
                            <div class="stock-btn" onclick="increaseStock()">+1</div>
                        </div>
                        <p class="text-gray-500 text-sm mt-2">Klik tombol +1 untuk menambah kuota dengan cepat</p>
                    </div>
                    <div>
                        <label class="block text-gray-800 font-semibold mb-3">Kategori</label>
                        <select id="category" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent text-gray-700 bg-gray-50">
                            <option value="fashion">Fashion</option>
                            <option value="elektronik">Elektronik</option>
                            <option value="makanan">Makanan & Minuman</option>
                            <option value="kecantikan">Kecantikan</option>
                            <option value="olahraga">Olahraga</option>
                            <option value="mainan">Mainan & Hobi</option>
                        </select>
                    </div>
                </div>

                <!-- Deskripsi -->
                <div class="mb-8">
                    <label class="block text-gray-800 font-semibold mb-3">Deskripsi Produk</label>
                    <textarea id="description" rows="5" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none bg-gray-50" placeholder="Tuliskan detail produk, kondisi, info promo mall, dsb."></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex items-center justify-between mb-8">
                    <button type="button" id="cancelBtn" class="px-8 py-3 text-gray-700 font-medium hover:bg-gray-100 rounded-lg transition">Batal</button>
                    <button type="submit" class="px-8 py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary-dark transition flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Simpan Perubahan</span>
                    </button>
                </div>

                <!-- Danger Zone -->
                <div class="danger-zone">
                    <h3 class="text-red-600 font-bold text-lg mb-2">Danger Zone</h3>
                    <p class="text-gray-700 text-sm mb-4">Hapus produk ini secara permanen dari toko kamu.</p>
                    <button type="button" id="deleteBtn" class="px-6 py-2 bg-white text-red-600 font-medium border border-red-300 rounded-lg hover:bg-red-50 transition flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        <span>Hapus Produk</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-primary text-white py-12 mt-20">
        <div class="max-w-7xl mx-auto px-6">
            <div class="grid grid-cols-4 gap-8">
                <div>
                    <div class="flex items-center space-x-2 mb-4">
                        <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center">
                            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                            </svg>
                        </div>
                        <span class="text-2xl font-bold">Promora</span>
                    </div>
                    <p class="text-purple-200 text-sm">Platform digital yang menghubungkan pencari promo dengan jastip terverifikasi.</p>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-4">Quick Links</h3>
                    <ul class="space-y-2 text-purple-200">
                        <li><a href="#" class="hover:text-white transition">Home</a></li>
                        <li><a href="#" class="hover:text-white transition">Promo</a></li>
                        <li><a href="#" class="hover:text-white transition">Jastip</a></li>
                        <li><a href="#" class="hover:text-white transition">About</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-4">Support</h3>
                    <ul class="space-y-2 text-purple-200">
                        <li><a href="#" class="hover:text-white transition">Help Center</a></li>
                        <li><a href="#" class="hover:text-white transition">FAQ</a></li>
                        <li><a href="#" class="hover:text-white transition">Terms & Conditions</a></li>
                        <li><a href="#" class="hover:text-white transition">Contact Us</a></li>
                    </ul>
                </div>
                
                <div>
                    <h3 class="font-semibold mb-4">Follow Us</h3>
                    <div class="flex space-x-3">
                        <a href="#" class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center hover:bg-opacity-30 transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073z"/><path d="M12 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                            </svg>
                        </a>
                        <a href="#" class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center hover:bg-opacity-30 transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/>
                            </svg>
                        </a>
                        <a href="#" class="w-10 h-10 bg-white bg-opacity-20 rounded-lg flex items-center justify-center hover:bg-opacity-30 transition">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="border-t border-purple-400 mt-8 pt-8 text-center text-purple-200 text-sm">
                © 2025 Promora — All rights reserved.
            </div>
        </div>
    </footer>
<script>
    // Status produk (aktif / nonaktif)
    let isActive = true;
    let productId = null;
    let currentProduct = null;
    
    // State untuk menyimpan foto
    let productImages = [null, null, null, null, null]; // Array untuk 5 foto
    let selectedImageIndex = null;

    // Get product ID from URL
    function getProductIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
    }

    // Fetch product data by ID
    async function fetchProductData(id) {
        try {
            console.log('Fetching product with ID:', id);
            const response = await fetch(`backend/api/products/get.php?id=${id}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            console.log('Product data:', data);
            return data;
            
        } catch (error) {
            console.error('Fetch error:', error);
            alert('Gagal memuat data produk: ' + error.message);
            setTimeout(() => {
                window.location.href = 'homeSeller.html';
            }, 2000);
            return null;
        }
    }

    // Render images
    function renderImages() {
        const container = document.querySelector('.flex.items-center.gap-4.mb-3');
        if (!container) return;
        
        container.innerHTML = '';
        
        productImages.forEach((imgSrc, index) => {
            if (imgSrc) {
                const div = document.createElement('div');
                div.className = 'product-image';
                div.style.position = 'relative';
                div.style.cursor = 'pointer';
                
                const img = document.createElement('img');
                img.src = imgSrc;
                img.alt = `Produk ${index + 1}`;
                img.onerror = function() {
                    this.src = 'https://via.placeholder.com/110x110?text=No+Image';
                };
                
                div.appendChild(img);
                
                // Badge cover untuk foto pertama
                if (index === 0) {
                    const badge = document.createElement('div');
                    badge.className = 'cover-badge';
                    badge.textContent = 'Cover';
                    div.appendChild(badge);
                }
                
                // Tombol hapus
                const removeBtn = document.createElement('div');
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '8px';
                removeBtn.style.right = '8px';
                removeBtn.style.width = '24px';
                removeBtn.style.height = '24px';
                removeBtn.style.backgroundColor = '#EF4444';
                removeBtn.style.color = 'white';
                removeBtn.style.borderRadius = '50%';
                removeBtn.style.display = 'flex';
                removeBtn.style.alignItems = 'center';
                removeBtn.style.justifyContent = 'center';
                removeBtn.style.cursor = 'pointer';
                removeBtn.style.fontSize = '18px';
                removeBtn.style.fontWeight = 'bold';
                removeBtn.style.zIndex = '10';
                removeBtn.innerHTML = '×';
                removeBtn.onmouseover = function() {
                    this.style.backgroundColor = '#DC2626';
                };
                removeBtn.onmouseout = function() {
                    this.style.backgroundColor = '#EF4444';
                };
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeImage(index);
                };
                
                div.appendChild(removeBtn);
                
                // Click untuk ganti foto
                div.onclick = () => {
                    selectedImageIndex = index;
                    document.getElementById('fileInput').click();
                };
                
                container.appendChild(div);
            }
        });
        
        // Update tombol ganti foto
        const changeBtn = document.getElementById('changePhotoBtn');
        if (changeBtn) {
            const filledCount = productImages.filter(img => img !== null).length;
            if (filledCount >= 5) {
                changeBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg><span>Ganti Foto Produk</span>';
            } else {
                changeBtn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg><span>Tambah Foto Produk</span>';
            }
        }
    }

    // Remove image
    function removeImage(index) {
        if (index === 0 && productImages.filter(img => img !== null).length === 1) {
            alert('Minimal harus ada 1 foto produk!');
            return;
        }
        
        if (confirm('Hapus foto ini?')) {
            // Geser foto ke kiri jika hapus foto di tengah
            productImages.splice(index, 1);
            productImages.push(null);
            renderImages();
        }
    }

    // Populate form with product data
    function populateForm(product) {
        if (!product) return;
        
        currentProduct = product;
        
        console.log('Populating form with:', product);
        
        // Populate all fields
        document.getElementById('productName').value = product.name || '';
        document.getElementById('brand').value = product.brand || '';
        document.getElementById('price').value = product.price || '';
        document.getElementById('originalPrice').value = product.original_price || '';
        document.getElementById('discount').value = product.discount || '';
        document.getElementById('fee').value = product.fee || '';
        document.getElementById('stock').value = product.stock || '';
        document.getElementById('description').value = product.description || '';
        
        const categorySelect = document.getElementById('category');
        if (product.category) {
            categorySelect.value = product.category;
        }
        
        // Load existing images
        productImages = [
            product.image || null,
            product.image2 || null,
            product.image3 || null,
            product.image4 || null,
            product.image5 || null
        ];
        
        renderImages();
        
        isActive = true;
        console.log('✅ Form populated successfully');
    }

    // Initialize page
    async function initPage() {
        productId = getProductIdFromURL();
        
        if (!productId) {
            alert('ID Produk tidak ditemukan!');
            window.location.href = 'homeSeller.html';
            return;
        }
        
        console.log('Loading product ID:', productId);
        const product = await fetchProductData(productId);
        
        if (product) {
            populateForm(product);
        }
    }

    // Tambah stok +1
    function increaseStock() {
        const stockInput = document.getElementById('stock');
        let current = parseInt(stockInput.value) || 0;
        stockInput.value = current + 1;
    }

    // Format angka menjadi mata uang
    function formatCurrency(input) {
        let value = input.value.replace(/\D/g, '');
        input.value = value;
    }

    // Format tampilan harga dengan titik
    function formatRupiah(angka) {
        return angka.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Page loaded, initializing...');
        
        // Format otomatis saat mengetik harga & fee
        ['price', 'fee', 'originalPrice'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', function () {
                    formatCurrency(this);
                });
            }
        });

        // Ganti/Tambah foto produk
        const changePhotoBtn = document.getElementById('changePhotoBtn');
        if (changePhotoBtn) {
            changePhotoBtn.addEventListener('click', () => {
                const emptyIndex = productImages.findIndex(img => img === null);
                if (emptyIndex !== -1) {
                    selectedImageIndex = emptyIndex;
                } else {
                    selectedImageIndex = 0; // Replace first image if all slots filled
                }
                document.getElementById('fileInput').click();
            });
        }

        // Handle file input change
const fileInput = document.getElementById('fileInput');
if (fileInput) {
    fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        if (files.length === 0) return;
        
        // Jika ada index yang dipilih (dari klik foto), ganti foto tersebut
        if (selectedImageIndex !== null) {
            const file = files[0];
            
            // Validasi ukuran
            if (file.size > 5 * 1024 * 1024) {
                alert('Ukuran file maksimal 5MB!');
                fileInput.value = ''; // TAMBAHKAN INI
                return;
            }
            
            // Validasi tipe
            if (!['image/jpeg', 'image/png'].includes(file.type)) {
                alert('Hanya file JPG/PNG yang diperbolehkan!');
                fileInput.value = ''; // TAMBAHKAN INI
                return;
            }
            
            // Preview
            const reader = new FileReader();
            reader.onload = (ev) => {
                productImages[selectedImageIndex] = ev.target.result;
                renderImages();
                selectedImageIndex = null; // PINDAHKAN KE SINI
                fileInput.value = ''; // PINDAHKAN KE SINI
            };
            reader.readAsDataURL(file);
        } else {
            // Jika tidak ada index (dari tombol tambah), tambahkan foto baru
            let processedCount = 0;
            const totalFiles = Math.min(files.length, 5);
            
            Array.from(files).slice(0, 5).forEach((file) => {
                const emptyIndex = productImages.findIndex(img => img === null);
                if (emptyIndex === -1) {
                    processedCount++;
                    return;
                }
                
                // Validasi
                if (file.size > 5 * 1024 * 1024) {
                    alert(`File ${file.name} terlalu besar! Maksimal 5MB.`);
                    processedCount++;
                    return;
                }
                
                if (!['image/jpeg', 'image/png'].includes(file.type)) {
                    alert(`File ${file.name} bukan format JPG/PNG!`);
                    processedCount++;
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    productImages[emptyIndex] = ev.target.result;
                    processedCount++;
                    
                    // Render hanya setelah semua file selesai diproses
                    if (processedCount === totalFiles) {
                        renderImages();
                        fileInput.value = '';
                    }
                };
                reader.readAsDataURL(file);
            });
        }
        
        // HAPUS BAGIAN INI - sudah dipindahkan ke dalam callback
        // fileInput.value = '';
        // selectedImageIndex = null;
    });
}
        // Submit form (update product)
        const editForm = document.getElementById('editProductForm');
        if (editForm) {
            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // Validasi
                const name = document.getElementById('productName').value.trim();
                const price = parseInt(document.getElementById('price').value) || 0;
                const stock = parseInt(document.getElementById('stock').value) || 0;

                if (!name || price <= 0 || stock < 0) {
                    alert('Pastikan Nama Produk, Harga, dan Kuota diisi dengan benar.');
                    return;
                }

                // Check if at least one image exists
                if (!productImages.some(img => img !== null)) {
                    alert('Minimal harus ada 1 foto produk!');
                    return;
                }

                // Prepare FormData
                const formData = new FormData();
                formData.append('id', productId);
                formData.append('name', name);
                formData.append('brand', document.getElementById('brand').value.trim());
                formData.append('price', price);
                formData.append('fee', parseInt(document.getElementById('fee').value) || 0);
                formData.append('stock', stock);
                formData.append('original_price', parseInt(document.getElementById('originalPrice').value) || 0);
                formData.append('discount', parseInt(document.getElementById('discount').value) || 0);
                formData.append('category', document.getElementById('category').value);
                formData.append('description', document.getElementById('description').value.trim());

                // PERBAIKAN: Kirim semua gambar dengan benar
                let newImageFiles = [];
                let hasNewImages = false;

                for (let i = 0; i < productImages.length; i++) {
                    if (productImages[i]) {
                        if (productImages[i].startsWith('data:')) {
                            // Gambar baru (base64) - konversi ke file
                            const blob = await fetch(productImages[i]).then(r => r.blob());
                            const file = new File([blob], `image${i}.jpg`, { type: 'image/jpeg' });
                            newImageFiles.push(file);
                            hasNewImages = true;
                        } else {
                            // Gambar lama (URL) - tetap simpan di existing_image
                            formData.append(`existing_image${i}`, productImages[i]);
                        }
                    } else {
                        // Slot kosong - kirim null untuk existing_image
                        formData.append(`existing_image${i}`, '');
                    }
                }

                // Append file gambar baru
                if (hasNewImages) {
                    newImageFiles.forEach(file => {
                        formData.append('images[]', file);
                    });
                }

                console.log('Updating Product...');

                try {
                    const response = await fetch('backend/api/products/update.php', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (result.error) {
                        throw new Error(result.error);
                    }

                    alert('✅ Perubahan berhasil disimpan!\n\nProduk: ' + name);
                    
                    setTimeout(() => {
                        window.location.href = 'homeSeller.html';
                    }, 1000);

                } catch (error) {
                    console.error('Update error:', error);
                    alert('❌ Gagal menyimpan perubahan: ' + error.message);
                }
            });
        }

        // Tombol Batal
        const cancelBtn = document.getElementById('cancelBtn');
        if (cancelBtn) {
            cancelBtn.addEventListener('click', () => {
                if (confirm('Batalkan semua perubahan?\nSemua data yang belum disimpan akan hilang.')) {
                    window.location.href = 'homeSeller.html';
                }
            });
        }

        // Tombol Hapus Produk (Danger Zone)
        const deleteBtn = document.getElementById('deleteBtn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', async () => {
                const namaProduk = document.getElementById('productName').value.trim() || 'produk ini';

                if (!confirm(`⚠️ PERINGATAN!\n\nApakah Anda yakin ingin menghapus produk "${namaProduk}"?\nTindakan ini TIDAK DAPAT DIBALIK!`)) {
                    return;
                }

                if (!confirm(`KONFIRMASI TERAKHIR:\nHapus produk "${namaProduk}" secara permanen?`)) {
                    return;
                }

                try {
                    const response = await fetch('backend/api/products/delete.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: productId })
                    });

                    const result = await response.json();

                    if (result.error) {
                        throw new Error(result.error);
                    }

                    alert(`✅ Produk "${namaProduk}" telah berhasil dihapus dari toko Anda.`);
                    window.location.href = 'homeSeller.html';

                } catch (error) {
                    console.error('Delete error:', error);
                    alert('❌ Gagal menghapus produk: ' + error.message);
                }
            });
        }

        // Auto-resize textarea
        const descTextarea = document.getElementById('description');
        if (descTextarea) {
            descTextarea.addEventListener('input', function () {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        }
        
        // Initialize product data
        initPage();
    });
</script>
    </body>
</html>